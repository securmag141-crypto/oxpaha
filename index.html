<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Личный кабинет Охранника</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Roboto', sans-serif; background: #0a192f; color: #e6f1ff; line-height: 1.6; }
        
        /* HEADER */
        header { 
            background: linear-gradient(135deg, #0a192f, #112240); 
            color: #7CFC00; /* Салатовый вместо ярко-голубого */
            padding: 1rem; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            border-bottom: 2px solid #7CFC00;
        }
        .logo { 
            font-size: 1.4rem; 
            font-weight: 700; 
            display: flex; 
            align-items: center; 
            gap: 12px; 
        }
        .logo i { color: #7CFC00; }
        nav ul { display: flex; list-style: none; gap: 1rem; flex-wrap: wrap; }
        nav a { 
            color: #ccd6f6; 
            text-decoration: none; 
            font-weight: 500; 
            padding: 0.6rem 1rem; 
            border-radius: 6px; 
            transition: all 0.3s; 
            font-size: 0.95rem; 
            white-space: nowrap;
            background: rgba(124, 252, 0, 0.1);
        }
        nav a:hover { 
            background: rgba(124, 252, 0, 0.2); 
            color: #7CFC00;
            transform: translateY(-2px);
        }
        
        /* MAIN */
        main { max-width: 1400px; margin: 1.5rem auto; padding: 0 1rem; }
        .container { 
            background: #112240; 
            border-radius: 12px; 
            box-shadow: 0 8px 30px rgba(0,0,0,0.4); 
            padding: 1.8rem; 
            margin-bottom: 1.8rem;
            border: 1px solid #233554;
        }
        h1 { 
            color: #7CFC00; 
            margin-bottom: 1.2rem; 
            border-bottom: 2px solid #7CFC00; 
            padding-bottom: 0.6rem; 
            font-size: 1.6rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        h2 { 
            color: #ccd6f6; 
            margin: 1.2rem 0 0.6rem; 
            font-size: 1.3rem;
            border-left: 4px solid #7CFC00;
            padding-left: 10px;
        }
        h3 { 
            color: #a8b2d1; 
            margin: 1rem 0 0.5rem; 
            font-size: 1.1rem; 
        }
        
        /* TABS */
        .tabs { 
            display: flex; 
            border-bottom: 2px solid #233554; 
            margin-bottom: 1.8rem; 
            overflow-x: auto; 
        }
        .tab { 
            padding: 0.9rem 1.4rem; 
            background: none; 
            border: none; 
            font-size: 1rem; 
            color: #8892b0; 
            cursor: pointer; 
            white-space: nowrap; 
            border-bottom: 3px solid transparent; 
            transition: all 0.3s;
        }
        .tab.active { 
            color: #7CFC00; 
            border-bottom-color: #7CFC00; 
            font-weight: 600; 
            background: rgba(124, 252, 0, 0.05);
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* FORMS */
        .form-group { margin-bottom: 1.2rem; }
        label { 
            display: block; 
            margin-bottom: 0.4rem; 
            font-weight: 500; 
            color: #a8b2d1; 
            font-size: 0.95rem; 
        }
        input, select, button, textarea { 
            width: 100%; 
            padding: 0.8rem; 
            border: 1px solid #233554; 
            border-radius: 6px; 
            font-size: 0.95rem; 
            background: #0a192f;
            color: #e6f1ff;
            transition: all 0.3s;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #7CFC00;
            box-shadow: 0 0 0 2px rgba(124, 252, 0, 0.2);
        }
        button { 
            background: linear-gradient(to right, #7CFC00, #32CD32); 
            color: #0a192f; 
            border: none; 
            cursor: pointer; 
            font-weight: 600; 
            transition: all 0.3s; 
            font-size: 1rem;
        }
        button:hover { 
            background: linear-gradient(to right, #32CD32, #228B22); 
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(124, 252, 0, 0.3);
        }
        .btn-secondary { 
            background: #495670; 
            color: #e6f1ff;
        }
        .btn-secondary:hover { 
            background: #3d4a5e;
            transform: translateY(-2px);
        }
        .btn-success { 
            background: linear-gradient(to right, #20c997, #17a589); 
            color: white;
        }
        .btn-success:hover { 
            background: linear-gradient(to right, #17a589, #12876f);
        }
        .btn-danger { 
            background: linear-gradient(to right, #ff6b6b, #ee5a52); 
            color: white;
        }
        .btn-danger:hover { 
            background: linear-gradient(to right, #ee5a52, #d64541);
        }
        .btn-small { 
            padding: 0.5rem 1rem; 
            font-size: 0.85rem; 
        }
        
        /* ТАБЛИЦА СМЕН АДМИНА - ИСПРАВЛЕННАЯ */
        .shifts-table-container {
            position: relative;
            margin-top: 1rem;
            overflow: hidden;
            border-radius: 8px;
            border: 1px solid #233554;
        }
        
        .shifts-scroll-wrapper {
            overflow-x: auto;
            position: relative;
        }
        
        .shifts-scroll-controls {
            position: absolute;
            top: 50%;
            right: 10px;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 100;
        }
        
        .scroll-btn {
            background: rgba(124, 252, 0, 0.2);
            color: #7CFC00;
            border: 1px solid rgba(124, 252, 0, 0.3);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s;
            backdrop-filter: blur(5px);
        }
        
        .scroll-btn:hover {
            background: rgba(124, 252, 0, 0.4);
            transform: scale(1.1);
        }
        
        .shifts-admin-table { 
            width: 100%; 
            border-collapse: separate; 
            border-spacing: 0;
            font-size: 0.85rem;
            background: #0a192f;
            table-layout: fixed;
        }
        
        .shifts-admin-table th, 
        .shifts-admin-table td { 
            padding: 0.6rem; 
            text-align: center; 
            border-right: 1px solid #233554; 
            border-bottom: 1px solid #233554;
            min-width: 40px;
            height: 40px;
            overflow: hidden;
            white-space: nowrap;
        }
        
        .shifts-admin-table th { 
            background: #112240; 
            font-weight: 600; 
            color: #7CFC00;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .shifts-admin-table th:first-child,
        .shifts-admin-table td:first-child {
            position: sticky;
            left: 0;
            background: #112240;
            z-index: 20;
            min-width: 50px;
            max-width: 50px;
            border-right: 2px solid #7CFC00;
        }
        
        .shifts-admin-table th:nth-child(2),
        .shifts-admin-table td:nth-child(2) {
            position: sticky;
            left: 50px;
            background: #112240;
            z-index: 20;
            min-width: 200px;
            max-width: 200px;
            text-align: left;
            padding-left: 15px;
            border-right: 2px solid #7CFC00;
        }
        
        .shifts-admin-table tr:nth-child(even) td:not(:first-child):not(:nth-child(2)) {
            background: rgba(17, 34, 64, 0.5);
        }
        
        .shifts-admin-table tr:hover td:not(:first-child):not(:nth-child(2)) {
            background: rgba(124, 252, 0, 0.05);
        }
        
        .shifts-cell { 
            cursor: pointer; 
            border-radius: 4px;
            transition: all 0.2s;
            position: relative;
        }
        
        .shifts-cell:hover { 
            transform: scale(1.1); 
            box-shadow: 0 0 10px rgba(124, 252, 0, 0.3);
            z-index: 5;
        }
        
        /* ЦВЕТА СМЕН - ОБНОВЛЕННЫЕ */
        .shift-regular { background: #2ecc71; } /* зелёный */
        .shift-extra { background: #a3e4d7; } /* салатовый */
        .shift-dayoff { background: #3498db; } /* синий */
        .shift-paid { background: #9b59b6; } /* фиолетовый */
        .shift-problem { background: #e74c3c; } /* красный */
        .shift-done { background: #2c3e50; color: white; } /* чёрный */
        .shift-done-extra { background: #95a5a6; color: white; } /* серый */
        .shift-paid-extra { background: #e84393; color: white; } /* розовый */
        
        /* КОНТРОЛЫ ДЛЯ ТАБЛИЦЫ СМЕН */
        .shifts-controls { 
            display: flex; 
            gap: 1rem; 
            margin-bottom: 1.5rem; 
            align-items: center; 
            flex-wrap: wrap;
            background: #0a192f;
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid #233554;
        }
        .shifts-controls select, 
        .shifts-controls input { 
            flex: 1; 
            min-width: 150px; 
        }
        
        /* POSTS TABLE */
        .posts-table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 1rem; 
            font-size: 0.9rem;
            background: #0a192f;
            border-radius: 8px;
            overflow: hidden;
        }
        .posts-table th, 
        .posts-table td { 
            padding: 0.8rem; 
            text-align: left; 
            border-bottom: 1px solid #233554; 
        }
        .posts-table th { 
            background: #112240; 
            font-weight: 600; 
            color: #7CFC00;
        }
        .posts-table .post-controls { display: flex; gap: 0.5rem; }
        .post-row input, 
        .post-row select { 
            padding: 0.5rem; 
            font-size: 0.85rem; 
            background: #0a192f;
            color: #e6f1ff;
            border: 1px solid #233554;
        }
        .table-responsive { 
            overflow-x: auto; 
            border-radius: 8px;
            border: 1px solid #233554;
        }
        
        /* POSTS MANAGEMENT */
        .posts-management { margin-top: 2rem; }
        .posts-date-control { 
            display: flex; 
            gap: 1rem; 
            align-items: center; 
            margin-bottom: 1.5rem; 
            flex-wrap: wrap; 
            background: #0a192f;
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid #233554;
        }
        .posts-date-control input { 
            max-width: 200px; 
            background: #0a192f;
            color: #e6f1ff;
        }
        
        /* USER PROFILE */
        .user-profile { 
            background: linear-gradient(135deg, #112240, #0a192f); 
            color: #e6f1ff; 
            padding: 1.5rem; 
            border-radius: 12px; 
            margin-bottom: 1.8rem;
            border: 1px solid #7CFC00;
            box-shadow: 0 5px 20px rgba(124, 252, 0, 0.1);
        }
        .user-profile h1 { 
            color: #7CFC00; 
            border-bottom: none; 
            margin-bottom: 0.8rem; 
        }
        .profile-info { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); 
            gap: 1.2rem; 
            margin-top: 1.2rem; 
        }
        .profile-item { }
        .profile-label { 
            font-size: 0.85rem; 
            color: #a8b2d1; 
        }
        .profile-value { 
            font-size: 1.2rem; 
            font-weight: bold; 
            color: #7CFC00;
        }
        
        /* CALENDAR (для пользователя) */
        .calendar-grid { 
            display: grid; 
            grid-template-columns: repeat(7, 1fr); 
            gap: 8px; 
            margin-top: 1rem;
        }
        .calendar-header { 
            background: #233554; 
            color: #7CFC00; 
            padding: 0.8rem; 
            text-align: center; 
            font-weight: 600; 
            border-radius: 6px; 
            font-size: 0.9rem; 
        }
        .calendar-day { 
            background: #0a192f; 
            border: 1px solid #233554; 
            min-height: 80px; 
            padding: 0.5rem; 
            position: relative; 
            border-radius: 6px; 
            cursor: pointer; 
            transition: all 0.3s; 
        }
        .calendar-day:hover { 
            background: #112240; 
            border-color: #7CFC00;
            transform: translateY(-3px);
        }
        .day-number { 
            font-weight: bold; 
            margin-bottom: 0.3rem; 
            color: #7CFC00; 
            font-size: 0.95rem; 
        }
        .shift-marker { 
            height: 12px; 
            width: 100%; 
            border-radius: 3px; 
            margin-top: 4px;
            cursor: pointer;
        }
        
        /* SHIFT LEGEND */
        .legend { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 1rem; 
            margin: 1.2rem 0; 
            background: #0a192f;
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid #233554;
        }
        .legend-item { 
            display: flex; 
            align-items: center; 
            gap: 0.6rem; 
            font-size: 0.85rem;
            color: #a8b2d1;
        }
        .legend-color { 
            width: 18px; 
            height: 18px; 
            border-radius: 4px; 
            border: 1px solid #233554;
        }
        
        /* UTILS */
        .hidden { display: none !important; }
        .message { 
            padding: 1rem; 
            border-radius: 8px; 
            margin: 1rem 0; 
            font-size: 0.95rem; 
            border-left: 4px solid;
        }
        .error { 
            background: rgba(231, 76, 60, 0.1); 
            color: #ff6b6b; 
            border-left-color: #ff6b6b;
        }
        .success { 
            background: rgba(39, 174, 96, 0.1); 
            color: #2ecc71; 
            border-left-color: #2ecc71;
        }
        .flex { 
            display: flex; 
            gap: 1.2rem; 
            flex-wrap: wrap; 
        }
        .text-right { text-align: right; }
        
        /* FOOTER */
        footer { 
            text-align: center; 
            padding: 1.8rem; 
            color: #8892b0; 
            border-top: 1px solid #233554; 
            margin-top: 3rem; 
            font-size: 0.9rem; 
            background: #0a192f;
        }
        
        /* MOBILE */
        @media (max-width: 768px) {
            header { flex-direction: column; gap: 1rem; padding: 1rem; }
            nav ul { width: 100%; justify-content: center; }
            .container { padding: 1.2rem; }
            .tabs { overflow-x: scroll; -webkit-overflow-scrolling: touch; }
            .tab { padding: 0.7rem 1rem; font-size: 0.9rem; }
            .profile-info { grid-template-columns: 1fr; }
            .posts-date-control { flex-direction: column; align-items: flex-start; }
            .posts-date-control input { max-width: 100%; }
            .shifts-controls { flex-direction: column; align-items: stretch; }
            .shifts-controls select, 
            .shifts-controls input { min-width: 100%; }
            .calendar-grid { grid-template-columns: repeat(7, 1fr); gap: 5px; }
            .calendar-day { min-height: 70px; padding: 0.4rem; }
            .calendar-header { padding: 0.6rem; font-size: 0.8rem; }
            .shift-marker { height: 10px; }
            .shifts-scroll-controls { display: none; }
            .shifts-admin-table th:nth-child(2),
            .shifts-admin-table td:nth-child(2) {
                min-width: 150px;
                max-width: 150px;
            }
        }
        
        @media (max-width: 480px) {
            .calendar-day { min-height: 60px; }
            .day-number { font-size: 0.85rem; }
            .calendar-header { font-size: 0.75rem; padding: 0.5rem; }
            nav a { padding: 0.5rem 0.8rem; font-size: 0.85rem; }
        }
    </style>
</head>
<body>
    <!-- HEADER -->
    <header>
        <div class="logo">
            <i class="fas fa-shield-alt"></i>
            <span>Личный кабинет Охранника</span>
        </div>
        <nav>
            <ul>
                <li><a href="#" id="nav-home"><i class="fas fa-home"></i> Главная</a></li>
                <li><a href="#" id="nav-login"><i class="fas fa-sign-in-alt"></i> Вход</a></li>
                <li><a href="#" id="nav-admin" class="hidden"><i class="fas fa-user-cog"></i> Админ</a></li>
                <li><a href="#" id="nav-user" class="hidden"><i class="fas fa-user"></i> Кабинет</a></li>
                <li><a href="#" id="nav-logout" class="hidden"><i class="fas fa-sign-out-alt"></i> Выход</a></li>
            </ul>
        </nav>
    </header>

    <!-- MAIN CONTENT -->
    <main>
        <!-- WELCOME SECTION -->
        <section id="welcome-section" class="container">
            <h1><i class="fas fa-shield-alt"></i> Система планирования смен</h1>
            <p style="color: #a8b2d1; font-size: 1.1rem;">Администраторы назначают смены, сотрудники просматривают свои графики работы.</p>
            <button id="go-to-login" onclick="app.showSection('login-section')"><i class="fas fa-sign-in-alt"></i> Вход в систему</button>
        </section>

        <!-- LOGIN SECTION -->
        <section id="login-section" class="container hidden">
            <h1><i class="fas fa-sign-in-alt"></i> Авторизация</h1>
            <div class="form-group">
                <label for="login-email">Email:</label>
                <input type="email" id="login-email" placeholder="admin@example.com">
            </div>
            <div class="form-group">
                <label for="login-password">Пароль:</label>
                <input type="password" id="login-password" placeholder="Ваш пароль">
            </div>
            <button id="login-btn"><i class="fas fa-sign-in-alt"></i> Войти</button>
            <div id="login-message" class="message hidden"></div>
        </section>

        <!-- ADMIN SECTION -->
        <section id="admin-section" class="container hidden">
            <div class="tabs">
                <button class="tab active" data-tab="shifts-admin"><i class="fas fa-calendar-alt"></i> Смены</button>
                <button class="tab" data-tab="payments"><i class="fas fa-money-bill-wave"></i> Выплаты</button>
                <button class="tab" data-tab="posts-admin"><i class="fas fa-clipboard-list"></i> Постовая</button>
                <button class="tab" data-tab="users-admin"><i class="fas fa-users"></i> Сотрудники</button>
            </div>
            
            <!-- ВКЛАДКА: СМЕНЫ (АДМИН) -->
            <div id="tab-shifts-admin" class="tab-content active">
                <h1><i class="fas fa-user-cog"></i> Административная панель</h1>
                
                <div class="shifts-controls">
                    <div class="form-group" style="flex: 1;">
                        <label>Месяц:</label>
                        <select id="selected-month">
                            <option value="0">Январь</option><option value="1">Февраль</option>
                            <option value="2">Март</option><option value="3">Апрель</option>
                            <option value="4">Май</option><option value="5">Июнь</option>
                            <option value="6">Июль</option><option value="7">Август</option>
                            <option value="8">Сентябрь</option><option value="9">Октябрь</option>
                            <option value="10">Ноябрь</option><option value="11">Декабрь</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>Год:</label>
                        <input type="number" id="selected-year" value="2024">
                    </div>
                    <div style="flex: 2; display: flex; align-items: flex-end;">
                        <button id="load-all-shifts-btn" class="btn-success"><i class="fas fa-sync-alt"></i> Загрузить смены</button>
                        <button id="save-all-shifts-btn" style="margin-left: 10px;"><i class="fas fa-save"></i> Сохранить все</button>
                    </div>
                </div>
                
                <!-- ЦВЕТА СМЕН -->
                <div class="legend">
                    <div class="legend-item"><div class="legend-color shift-regular"></div><span>Обычная</span></div>
                    <div class="legend-item"><div class="legend-color shift-extra"></div><span>Подработка</span></div>
                    <div class="legend-item"><div class="legend-color shift-done"></div><span>Отработано</span></div>
                    <div class="legend-item"><div class="legend-color shift-done-extra"></div><span>Подработка отр.</span></div>
                    <div class="legend-item"><div class="legend-color shift-paid"></div><span>Оплачено</span></div>
                    <div class="legend-item"><div class="legend-color shift-paid-extra"></div><span>Подр. оплач.</span></div>
                    <div class="legend-item"><div class="legend-color shift-dayoff"></div><span>Выходной</span></div>
                    <div class="legend-item"><div class="legend-color shift-problem"></div><span>Проблема</span></div>
                </div>
                
                <!-- ТАБЛИЦА СМЕН АДМИНА -->
                <div class="shifts-table-container">
                    <div class="shifts-scroll-wrapper" id="shifts-scroll-wrapper">
                        <table class="shifts-admin-table" id="admin-shifts-table">
                            <thead>
                                <tr>
                                    <th rowspan="2">№</th>
                                    <th rowspan="2">Сотрудник</th>
                                    <th colspan="31" id="table-month-year">Январь 2024</th>
                                </tr>
                                <tr id="days-header">
                                    <!-- Дни месяца будут добавлены через JS -->
                                </tr>
                            </thead>
                            <tbody id="shifts-table-body">
                                <!-- Данные будут добавлены через JS -->
                            </tbody>
                        </table>
                    </div>
                    <div class="shifts-scroll-controls">
                        <button class="scroll-btn" id="scroll-left-btn"><i class="fas fa-chevron-left"></i></button>
                        <button class="scroll-btn" id="scroll-right-btn"><i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>
            </div>
            
            <!-- ВКЛАДКА: ВЫПЛАТЫ -->
            <div id="tab-payments" class="tab-content">
                <h2><i class="fas fa-money-bill-wave"></i> Управление выплатами</h2>
                <div class="flex">
                    <div class="form-group" style="flex: 1;">
                        <label>Охранник:</label>
                        <select id="payment-user"></select>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>Период с:</label>
                        <input type="date" id="period-from">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>Период по:</label>
                        <input type="date" id="period-to">
                    </div>
                </div>
                <div class="flex">
                    <div class="form-group" style="flex: 1;">
                        <label>Премия:</label>
                        <input type="number" id="bonus-amount" placeholder="Сумма (+)" value="0">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>Удержание:</label>
                        <input type="number" id="penalty-amount" placeholder="Сумма (-)" value="0">
                    </div>
                    <div class="form-group" style="flex: 2;">
                        <label>Примечание:</label>
                        <textarea id="bonus-note" placeholder="Причина" rows="1"></textarea>
                    </div>
                </div>
                <button id="calculate-payment-btn" class="btn-success"><i class="fas fa-calculator"></i> Рассчитать и выплатить</button>
                <div id="calculation-result"></div>
            </div>
            
            <!-- ВКЛАДКА: ПОСТОВАЯ (АДМИН) -->
            <div id="tab-posts-admin" class="tab-content">
                <h2><i class="fas fa-clipboard-list"></i> Управление постовой</h2>
                
                <div class="posts-management">
                    <!-- ВЫБОР ДАТЫ -->
                    <div class="posts-date-control">
                        <div class="form-group">
                            <label>Выберите дату для постовой:</label>
                            <input type="date" id="posts-date" value="">
                        </div>
                        <div>
                            <button id="load-posts-btn" class="btn-success"><i class="fas fa-search"></i> Загрузить посты</button>
                            <button id="create-template-btn" class="btn-secondary" style="margin-left: 10px;"><i class="fas fa-magic"></i> Создать шаблон</button>
                        </div>
                    </div>
                    
                    <!-- ТАБЛИЦА ПОСТОВ -->
                    <div id="posts-admin-container">
                        <div class="message">
                            <p>Выберите дату и загрузите посты или создайте новый шаблон</p>
                        </div>
                    </div>
                    
                    <!-- СПИСОК ШАБЛОНОВ -->
                    <h3 style="margin-top: 2rem;"><i class="fas fa-list"></i> Предустановленные посты (шаблон)</h3>
                    <div class="table-responsive">
                        <table class="posts-table">
                            <thead>
                                <tr>
                                    <th>№</th>
                                    <th>Пост</th>
                                    <th>Время</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody id="posts-template">
                                <!-- Шаблон загрузится через JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- ВКЛАДКА: СОТРУДНИКИ -->
            <div id="tab-users-admin" class="tab-content">
                <h2><i class="fas fa-users"></i> Управление сотрудниками</h2>
                
                <div class="flex">
                    <div style="flex: 1;">
                        <h3><i class="fas fa-user-plus"></i> Новый охранник</h3>
                        <div class="form-group">
                            <input type="email" id="new-user-email" placeholder="Email охранника">
                        </div>
                        <div class="form-group">
                            <input type="password" id="new-user-password" placeholder="Пароль">
                        </div>
                        <div class="form-group">
                            <input type="text" id="new-user-lastname" placeholder="Фамилия">
                        </div>
                        <div class="form-group">
                            <input type="text" id="new-user-firstname" placeholder="Имя">
                        </div>
                        <div class="form-group">
                            <input type="number" id="new-user-rate" placeholder="Ставка за смену" value="1500">
                        </div>
                        <button id="create-user-btn"><i class="fas fa-plus"></i> Создать охранника</button>
                    </div>
                    
                    <div style="flex: 2;">
                        <h3><i class="fas fa-users"></i> Все охранники</h3>
                        <div id="users-container" class="user-list" style="max-height: 400px; overflow-y: auto; padding: 1rem; background: #0a192f; border-radius: 8px; border: 1px solid #233554;">
                            <!-- Список сотрудников загрузится через JS -->
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- USER SECTION -->
        <section id="user-section" class="container hidden">
            <!-- ПРОФИЛЬ ПОЛЬЗОВАТЕЛЯ -->
            <div class="user-profile">
                <h1><i class="fas fa-user"></i> <span id="user-full-name">Фамилия Имя</span></h1>
                <div class="profile-info">
                    <div class="profile-item">
                        <div class="profile-label">Должность</div>
                        <div class="profile-value" id="user-position">Охранник</div>
                    </div>
                    <div class="profile-item">
                        <div class="profile-label">Ставка за смену</div>
                        <div class="profile-value" id="user-rate">0 ₽</div>
                    </div>
                    <div class="profile-item">
                        <div class="profile-label">Email</div>
                        <div class="profile-value" id="user-email">email@example.com</div>
                    </div>
                </div>
            </div>
            
            <!-- ВКЛАДКИ ПОЛЬЗОВАТЕЛЯ -->
            <div class="tabs">
                <button class="tab active" data-tab="shifts"><i class="fas fa-calendar-alt"></i> Смены</button>
                <button class="tab" data-tab="posts"><i class="fas fa-clipboard-list"></i> Постовая</button>
                <button class="tab" data-tab="payments"><i class="fas fa-money-bill-wave"></i> Выплаты</button>
            </div>
            
            <!-- ВКЛАДКА: СМЕНЫ -->
            <div id="tab-shifts" class="tab-content active">
                <h2><i class="fas fa-calendar-alt"></i> Мой график смен</h2>
                <div class="legend">
                    <div class="legend-item"><div class="legend-color shift-regular"></div><span>Обычная</span></div>
                    <div class="legend-item"><div class="legend-color shift-extra"></div><span>Подработка</span></div>
                    <div class="legend-item"><div class="legend-color shift-done"></div><span>Отработано</span></div>
                    <div class="legend-item"><div class="legend-color shift-done-extra"></div><span>Подработка отр.</span></div>
                    <div class="legend-item"><div class="legend-color shift-paid"></div><span>Оплачено</span></div>
                    <div class="legend-item"><div class="legend-color shift-paid-extra"></div><span>Подр. оплач.</span></div>
                    <div class="legend-item"><div class="legend-color shift-dayoff"></div><span>Выходной</span></div>
                    <div class="legend-item"><div class="legend-color shift-problem"></div><span>Проблема</span></div>
                </div>
                <div id="user-calendar" class="calendar-grid"></div>
            </div>
            
            <!-- ВКЛАДКА: ПОСТОВАЯ -->
            <div id="tab-posts" class="tab-content">
                <h2><i class="fas fa-clipboard-list"></i> Расписание постов</h2>
                <div id="posts-user-container">
                    <div class="message">
                        <p>Выберите дату для просмотра постов:</p>
                        <div class="form-group" style="max-width: 200px; margin-top: 10px;">
                            <input type="date" id="user-posts-date" value="">
                        </div>
                        <button id="load-user-posts-btn" class="btn-success" style="margin-top: 10px;"><i class="fas fa-search"></i> Загрузить</button>
                    </div>
                </div>
            </div>
            
            <!-- ВКЛАДКА: ВЫПЛАТЫ -->
            <div id="tab-payments" class="tab-content">
                <h2><i class="fas fa-money-bill-wave"></i> Выплаты</h2>
                
                <!-- ОЖИДАЕМЫЕ ВЫПЛАТЫ -->
                <h3><i class="fas fa-clock"></i> Ожидаемые выплаты</h3>
                <div class="table-responsive">
                    <table class="posts-table">
                        <thead>
                            <tr>
                                <th>Тип смены</th>
                                <th>Количество</th>
                                <th>Ставка</th>
                                <th>Сумма</th>
                            </tr>
                        </thead>
                        <tbody id="pending-payments">
                            <tr><td colspan="4">Нет ожидающих выплат</td></tr>
                        </tbody>
                        <tfoot>
                            <tr style="font-weight: bold; color: #7CFC00;">
                                <td colspan="3">Итого к выплате:</td>
                                <td id="pending-total">0 ₽</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                
                <!-- ИСТОРИЯ ВЫПЛАТ -->
                <h3 style="margin-top: 2rem;"><i class="fas fa-history"></i> История выплат</h3>
                <div class="table-responsive">
                    <table class="posts-table">
                        <thead>
                            <tr>
                                <th>Дата</th>
                                <th>Период</th>
                                <th>Обычные</th>
                                <th>Подработки</th>
                                <th>Сумма</th>
                                <th>Премия</th>
                                <th>Удержание</th>
                                <th>Примечание</th>
                                <th>Итого</th>
                            </tr>
                        </thead>
                        <tbody id="payments-history">
                            <tr><td colspan="9">Нет выплат</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>

    <!-- FOOTER -->
    <footer>
        <p>© 2024 Личный кабинет Охранника. Работает на Firebase.</p>
        <p style="margin-top: 10px; font-size: 0.8rem; color: #495670;"><i class="fas fa-shield-alt"></i> Безопасность и надежность</p>
    </footer>

    <!-- FIREBASE & APP -->
    <script>
        // === FIREBASE CONFIG ===
        const firebaseConfig = {
            apiKey: "AIzaSyAy60J96o9uzaEx96NQVSFVBNCRxn4NFWY",
            authDomain: "ssss-7ac80.firebaseapp.com",
            projectId: "ssss-7ac80",
            storageBucket: "ssss-7ac80.firebasestorage.app",
            messagingSenderId: "185019094690",
            appId: "1:185019094690:web:f75df54462ed848acd29fb"
        };
        
        // === ИНИЦИАЛИЗАЦИЯ ===
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // === БЕЗОПАСНЫЕ УТИЛИТЫ ===
        const app = {
            getElement: function(id) {
                const el = document.getElementById(id);
                if (!el && console) console.warn('Элемент не найден:', id);
                return el;
            },
            
            showSection: function(sectionId) {
                let fullId = sectionId;
                if (!sectionId.includes('-section')) {
                    fullId = sectionId + '-section';
                }
                
                const sections = ['welcome-section', 'login-section', 'admin-section', 'user-section'];
                sections.forEach(id => {
                    const el = this.getElement(id);
                    if (el) el.classList.add('hidden');
                });
                
                const targetSection = this.getElement(fullId);
                if (targetSection) {
                    targetSection.classList.remove('hidden');
                }
                this.updateNavigation();
            },
            
            updateNavigation: function() {
                const isLoggedIn = !!currentUser;
                const isAdmin = currentUser && allUsers.find(u => u.id === currentUser.uid && u.role === 'admin');
                
                const navHome = this.getElement('nav-home');
                const navLogin = this.getElement('nav-login');
                const navAdmin = this.getElement('nav-admin');
                const navUser = this.getElement('nav-user');
                const navLogout = this.getElement('nav-logout');
                
                if (navHome) navHome.classList.toggle('hidden', isLoggedIn);
                if (navLogin) navLogin.classList.toggle('hidden', isLoggedIn);
                if (navAdmin) navAdmin.classList.toggle('hidden', !isAdmin);
                if (navUser) navUser.classList.toggle('hidden', !isLoggedIn);
                if (navLogout) navLogout.classList.toggle('hidden', !isLoggedIn);
            },
            
            safeAddEventListener: function(id, event, handler) {
                const el = this.getElement(id);
                if (el) el.addEventListener(event, handler);
            },
            
            showMessage: function(elementId, text, isError = false) {
                const el = this.getElement(elementId);
                if (el) {
                    el.textContent = text;
                    el.className = `message ${isError ? 'error' : 'success'}`;
                    el.classList.remove('hidden');
                    setTimeout(() => el.classList.add('hidden'), 5000);
                }
            }
        };
        
        // === СОСТОЯНИЕ ===
        let currentUser = null;
        let allUsers = [];
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let shiftsMap = {};
        let postsData = [];
        let isAdmin = false;
        let adminShiftsData = {};
        
        // === ПРЕДУСТАНОВЛЕННЫЕ ПОСТЫ ===
        const defaultPosts = [
            { number: "1", post: "Старший смены", time: "06:00" },
            { number: "2", post: "Помощник ст.смены", time: "18:00" },
            { number: "3", post: "Оператор CCTV", time: "06:00" },
            { number: "4", post: "Оператор-аналитик ТСБ", time: "08:00" },
            { number: "3.1", post: "Оператор CCTV", time: "18:00" },
            { number: "5", post: "Служебный вход", time: "07:00" },
            { number: "6", post: "Выход без покупок", time: "07:15" },
            { number: "8", post: "КСО", time: "10:00" },
            { number: "11", post: "Приёмка", time: "07:00" },
            { number: "12", post: "Интернет", time: "07:30" },
            { number: "14", post: "Выезд со стройдвора", time: "07:15" },
            { number: "15", post: "Резерв", time: "08:00" }
        ];
        
        // === ТАБЫ ===
        function initTabs() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    this.classList.add('active');
                    const content = document.getElementById(`tab-${tabId}`);
                    if (content) content.classList.add('active');
                });
            });
        }
        
        // === АУТЕНТИФИКАЦИЯ ===
        app.safeAddEventListener('login-btn', 'click', async () => {
            const emailInput = app.getElement('login-email');
            const passwordInput = app.getElement('login-password');
            
            if (!emailInput || !passwordInput) return;
            
            const email = emailInput.value;
            const password = passwordInput.value;
            
            if (!email || !password) {
                alert('Введите email и пароль');
                return;
            }
            
            try {
                await auth.signInWithEmailAndPassword(email, password);
            } catch (error) {
                alert('Ошибка: ' + error.message);
            }
        });
        
        // === ЗАГРУЗКА ПОЛЬЗОВАТЕЛЕЙ ===
        async function loadUsers() {
            try {
                const snapshot = await db.collection('users').get();
                allUsers = [];
                snapshot.forEach(doc => {
                    const userData = doc.data();
                    let lastName = '';
                    let firstName = '';
                    
                    if (userData.fullName) {
                        const nameParts = userData.fullName.split(' ');
                        if (nameParts.length >= 2) {
                            lastName = nameParts[0];
                            firstName = nameParts.slice(1).join(' ');
                        } else {
                            firstName = userData.fullName;
                        }
                    }
                    
                    allUsers.push({ 
                        id: doc.id, 
                        ...userData,
                        lastName: lastName,
                        firstName: firstName,
                        displayName: lastName ? `${lastName} ${firstName}` : (userData.fullName || userData.email)
                    });
                });
                
                allUsers.sort((a, b) => {
                    if (a.lastName && b.lastName) {
                        return a.lastName.localeCompare(b.lastName);
                    }
                    return (a.displayName || '').localeCompare(b.displayName || '');
                });
                
                // Список сотрудников
                const container = app.getElement('users-container');
                if (container) {
                    container.innerHTML = allUsers.map((user, index) => `
                        <div class="user-card ${user.role === 'admin' ? 'admin' : ''}" style="background: #112240; padding: 0.8rem; margin: 0.5rem 0; border-radius: 5px; border: 1px solid #233554;">
                            <strong style="color: #7CFC00;">${user.displayName || user.email}</strong><br>
                            <small style="color: #a8b2d1;">${user.role === 'admin' ? 'Администратор' : 'Охранник'}</small><br>
                            <small style="color: #8892b0;">Ставка: ${user.rate || 0} ₽</small>
                        </div>
                    `).join('');
                }
                
                // Селект для выплат
                const paymentSelect = app.getElement('payment-user');
                if (paymentSelect) {
                    paymentSelect.innerHTML = '<option value="">Выберите охранника</option>';
                    allUsers.forEach(user => {
                        if (user.role !== 'admin') {
                            const option = document.createElement('option');
                            option.value = user.id;
                            option.textContent = `${user.displayName} (${user.rate || 0} ₽)`;
                            paymentSelect.appendChild(option);
                        }
                    });
                }
                
                if (isAdmin && document.getElementById('tab-shifts-admin')?.classList.contains('active')) {
                    await loadAllShiftsForAdmin();
                }
                
            } catch (error) {
                console.error('Ошибка загрузки пользователей:', error);
            }
        }
        
        // === СОЗДАНИЕ ПОЛЬЗОВАТЕЛЯ ===
        app.safeAddEventListener('create-user-btn', 'click', async () => {
            const emailInput = app.getElement('new-user-email');
            const passwordInput = app.getElement('new-user-password');
            const lastnameInput = app.getElement('new-user-lastname');
            const firstnameInput = app.getElement('new-user-firstname');
            const rateInput = app.getElement('new-user-rate');
            
            if (!emailInput || !passwordInput || !lastnameInput || !firstnameInput || !rateInput) return;
            
            const email = emailInput.value;
            const password = passwordInput.value;
            const lastName = lastnameInput.value.trim();
            const firstName = firstnameInput.value.trim();
            const rate = parseInt(rateInput.value) || 1500;
            
            if (!email || !password || !lastName || !firstName) {
                alert('Заполните все поля');
                return;
            }
            
            const fullName = `${lastName} ${firstName}`;
            
            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                await db.collection('users').doc(userCredential.user.uid).set({
                    email: email,
                    role: 'user',
                    fullName: fullName,
                    lastName: lastName,
                    firstName: firstName,
                    rate: rate,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                emailInput.value = '';
                passwordInput.value = '';
                lastnameInput.value = '';
                firstnameInput.value = '';
                rateInput.value = '1500';
                
                loadUsers();
                alert(`Охранник ${fullName} создан!`);
            } catch (error) {
                alert('Ошибка: ' + error.message);
            }
        });
        
        // === ЗАГРУЗКА ВСЕХ СМЕН ДЛЯ АДМИНА ===
        async function loadAllShiftsForAdmin() {
            try {
                const month = parseInt(app.getElement('selected-month')?.value || currentMonth);
                const year = parseInt(app.getElement('selected-year')?.value || currentYear);
                
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const startDate = firstDay.toISOString().split('T')[0];
                const endDate = lastDay.toISOString().split('T')[0];
                
                const snapshot = await db.collection('shifts')
                    .where('date', '>=', startDate)
                    .where('date', '<=', endDate)
                    .get();
                
                adminShiftsData = {};
                shiftsMap = {};
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const userId = data.userId;
                    const date = data.date;
                    
                    if (!adminShiftsData[userId]) {
                        adminShiftsData[userId] = {};
                    }
                    
                    adminShiftsData[userId][date] = {
                        type: data.type,
                        done: data.done || false,
                        paid: data.paid || false,
                        shiftId: doc.id
                    };
                    
                    if (!shiftsMap[userId]) {
                        shiftsMap[userId] = {};
                    }
                    shiftsMap[userId][date] = {
                        type: data.type,
                        done: data.done || false,
                        paid: data.paid || false
                    };
                });
                
                renderAdminShiftsTable(month, year);
                
            } catch (error) {
                console.error('Ошибка загрузки смен для админа:', error);
                alert('Ошибка загрузки смен: ' + error.message);
            }
        }
        
        // === РЕНДЕР ТАБЛИЦЫ СМЕН АДМИНА ===
        function renderAdminShiftsTable(month, year) {
            const tableBody = app.getElement('shifts-table-body');
            const daysHeader = app.getElement('days-header');
            const monthYearHeader = app.getElement('table-month-year');
            
            if (!tableBody || !daysHeader || !monthYearHeader) return;
            
            const monthNames = ['Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь', 
                               'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'];
            monthYearHeader.textContent = `${monthNames[month]} ${year}`;
            
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            let daysHtml = '';
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dayOfWeek = date.getDay();
                const dayNames = ['Вс', 'Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб'];
                
                daysHtml += `<th style="${dayOfWeek === 0 || dayOfWeek === 6 ? 'color: #ff6b6b;' : ''}">
                    ${day}<br><small style="font-size: 0.7rem; color: #8892b0;">${dayNames[dayOfWeek]}</small>
                </th>`;
            }
            daysHeader.innerHTML = daysHtml;
            
            const guards = allUsers.filter(user => user.role !== 'admin');
            
            let tableHtml = '';
            guards.forEach((guard, index) => {
                tableHtml += `<tr data-user-id="${guard.id}">`;
                tableHtml += `<td style="font-weight: bold; color: #7CFC00;">${index + 1}</td>`;
                tableHtml += `<td style="text-align: left; white-space: normal; word-wrap: break-word;"><strong>${guard.displayName}</strong><br><small style="color: #8892b0;">${guard.rate || 0} ₽</small></td>`;
                
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const shift = adminShiftsData[guard.id] ? adminShiftsData[guard.id][dateStr] : null;
                    
                    let shiftClass = '';
                    let title = 'Нет смены (клик для добавления)';
                    
                    if (shift) {
                        if (shift.type === 'regular') {
                            if (shift.paid) {
                                shiftClass = 'shift-paid';
                                title = 'Оплаченная обычная смена';
                            } else if (shift.done) {
                                shiftClass = 'shift-done';
                                title = 'Отработанная обычная смена';
                            } else {
                                shiftClass = 'shift-regular';
                                title = 'Обычная смена';
                            }
                        } else if (shift.type === 'extra') {
                            if (shift.paid) {
                                shiftClass = 'shift-paid-extra';
                                title = 'Оплаченная подработка';
                            } else if (shift.done) {
                                shiftClass = 'shift-done-extra';
                                title = 'Отработанная подработка';
                            } else {
                                shiftClass = 'shift-extra';
                                title = 'Подработка';
                            }
                        } else if (shift.type === 'dayoff') {
                            shiftClass = 'shift-dayoff';
                            title = 'Выходной';
                        } else if (shift.type === 'problem') {
                            shiftClass = 'shift-problem';
                            title = 'Проблемная смена';
                        }
                    }
                    
                    tableHtml += `
                        <td class="shifts-cell ${shiftClass}" 
                            data-user-id="${guard.id}" 
                            data-date="${dateStr}"
                            data-shift-type="${shift ? shift.type : ''}"
                            data-done="${shift ? shift.done : false}"
                            data-paid="${shift ? shift.paid : false}"
                            title="${title}"
                            style="position: relative;">
                            ${shift ? '' : '+'}
                        </td>`;
                }
                
                tableHtml += `</tr>`;
            });
            
            tableBody.innerHTML = tableHtml;
            
            tableBody.querySelectorAll('.shifts-cell').forEach(cell => {
                cell.addEventListener('click', function(e) {
                    handleShiftCellClick(this);
                });
            });
        }
        
        // === ОБРАБОТКА КЛИКА ПО ЯЧЕЙКЕ СМЕНЫ ===
        function handleShiftCellClick(cell) {
            const userId = cell.getAttribute('data-user-id');
            const date = cell.getAttribute('data-date');
            const currentType = cell.getAttribute('data-shift-type');
            const isDone = cell.getAttribute('data-done') === 'true';
            const isPaid = cell.getAttribute('data-paid') === 'true';
            
            if (isPaid) {
                alert('Смена уже оплачена, нельзя изменить');
                return;
            }
            
            const shiftCycle = [
                {type: 'regular', color: 'shift-regular', title: 'Обычная смена'},
                {type: 'extra', color: 'shift-extra', title: 'Подработка'},
                {type: 'dayoff', color: 'shift-dayoff', title: 'Выходной'},
                {type: 'problem', color: 'shift-problem', title: 'Проблемная смена'},
                {type: 'done', color: 'shift-done', title: 'Отработанная обычная'},
                {type: 'done-extra', color: 'shift-done-extra', title: 'Отработанная подработка'},
                null
            ];
            
            let currentIndex = shiftCycle.findIndex(item => 
                item ? item.type === currentType : currentType === ''
            );
            if (currentIndex === -1) currentIndex = shiftCycle.length - 1;
            
            const nextIndex = (currentIndex + 1) % shiftCycle.length;
            const nextItem = shiftCycle[nextIndex];
            
            cell.className = 'shifts-cell';
            if (nextItem) {
                cell.classList.add(nextItem.color);
                cell.setAttribute('data-shift-type', nextItem.type);
                cell.setAttribute('data-done', 
                    nextItem.type === 'done' || nextItem.type === 'done-extra' ? 'true' : 'false');
                cell.setAttribute('title', nextItem.title);
                cell.innerHTML = '';
            } else {
                cell.setAttribute('data-shift-type', '');
                cell.setAttribute('data-done', 'false');
                cell.setAttribute('data-paid', 'false');
                cell.setAttribute('title', 'Нет смены (клик для добавления)');
                cell.innerHTML = '+';
            }
            
            if (!adminShiftsData[userId]) adminShiftsData[userId] = {};
            
            if (nextItem) {
                let type, done, paid;
                
                if (nextItem.type === 'regular') {
                    type = 'regular'; done = false; paid = false;
                } else if (nextItem.type === 'extra') {
                    type = 'extra'; done = false; paid = false;
                } else if (nextItem.type === 'dayoff') {
                    type = 'dayoff'; done = false; paid = false;
                } else if (nextItem.type === 'problem') {
                    type = 'problem'; done = false; paid = false;
                } else if (nextItem.type === 'done') {
                    type = 'regular'; done = true; paid = false;
                } else if (nextItem.type === 'done-extra') {
                    type = 'extra'; done = true; paid = false;
                }
                
                adminShiftsData[userId][date] = { 
                    type, 
                    done, 
                    paid,
                    shiftId: adminShiftsData[userId][date]?.shiftId || null
                };
            } else {
                delete adminShiftsData[userId][date];
            }
            
            if (!shiftsMap[userId]) shiftsMap[userId] = {};
            if (nextItem) {
                let type, done, paid;
                
                if (nextItem.type === 'regular') {
                    type = 'regular'; done = false; paid = false;
                } else if (nextItem.type === 'extra') {
                    type = 'extra'; done = false; paid = false;
                } else if (nextItem.type === 'dayoff') {
                    type = 'dayoff'; done = false; paid = false;
                } else if (nextItem.type === 'problem') {
                    type = 'problem'; done = false; paid = false;
                } else if (nextItem.type === 'done') {
                    type = 'regular'; done = true; paid = false;
                } else if (nextItem.type === 'done-extra') {
                    type = 'extra'; done = true; paid = false;
                }
                
                shiftsMap[userId][date] = { type, done, paid };
            } else {
                delete shiftsMap[userId][date];
            }
        }
        
        // === СОХРАНЕНИЕ ВСЕХ СМЕН АДМИНА ===
        app.safeAddEventListener('save-all-shifts-btn', 'click', async () => {
            try {
                const month = parseInt(app.getElement('selected-month')?.value || currentMonth);
                const year = parseInt(app.getElement('selected-year')?.value || currentYear);
                const monthStr = String(month + 1).padStart(2, '0');
                
                const batch = db.batch();
                let changesCount = 0;
                
                for (const userId in adminShiftsData) {
                    const userShifts = adminShiftsData[userId];
                    
                    const oldShifts = await db.collection('shifts')
                        .where('userId', '==', userId)
                        .where('date', '>=', `${year}-${monthStr}-01`)
                        .where('date', '<=', `${year}-${monthStr}-31`)
                        .get();
                    
                    oldShifts.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    
                    for (const [date, shift] of Object.entries(userShifts)) {
                        if (date.startsWith(`${year}-${monthStr}`)) {
                            const shiftRef = db.collection('shifts').doc();
                            batch.set(shiftRef, {
                                userId: userId,
                                date: date,
                                type: shift.type,
                                done: shift.done || false,
                                paid: shift.paid || false,
                                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            changesCount++;
                        }
                    }
                }
                
                await batch.commit();
                alert(`Смены сохранены успешно! Изменено: ${changesCount} записей.`);
                
            } catch (error) {
                alert('Ошибка сохранения смен: ' + error.message);
            }
        });
        
        // === ЗАГРУЗКА СМЕН ПО КНОПКЕ ===
        app.safeAddEventListener('load-all-shifts-btn', 'click', async () => {
            await loadAllShiftsForAdmin();
        });
        
        // === СКРОЛЛ ТАБЛИЦЫ ===
        app.safeAddEventListener('scroll-left-btn', 'click', function() {
            const wrapper = document.getElementById('shifts-scroll-wrapper');
            if (wrapper) {
                wrapper.scrollBy({ left: -200, behavior: 'smooth' });
            }
        });
        
        app.safeAddEventListener('scroll-right-btn', 'click', function() {
            const wrapper = document.getElementById('shifts-scroll-wrapper');
            if (wrapper) {
                wrapper.scrollBy({ left: 200, behavior: 'smooth' });
            }
        });
        
        // === ОБНОВЛЕНИЕ ТАБЛИЦЫ ПРИ ИЗМЕНЕНИИ МЕСЯЦА/ГОДА ===
        app.safeAddEventListener('selected-month', 'change', async () => {
            if (isAdmin && document.getElementById('tab-shifts-admin')?.classList.contains('active')) {
                await loadAllShiftsForAdmin();
            }
        });
        
        app.safeAddEventListener('selected-year', 'change', async () => {
            if (isAdmin && document.getElementById('tab-shifts-admin')?.classList.contains('active')) {
                await loadAllShiftsForAdmin();
            }
        });
        
        // === КАЛЕНДАРЬ ПОЛЬЗОВАТЕЛЯ ===
        function renderUserCalendar() {
            const container = app.getElement('user-calendar');
            if (!container || !currentUser) return;
            
            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth();
            
            const days = ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'];
            let html = '';
            
            days.forEach(day => {
                html += `<div class="calendar-header">${day}</div>`;
            });
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const totalDays = lastDay.getDate();
            const startDay = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1;
            
            for (let i = 0; i < startDay; i++) {
                html += `<div class="calendar-day"></div>`;
            }
            
            for (let day = 1; day <= totalDays; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const userShifts = shiftsMap[currentUser.uid] || {};
                const shift = userShifts[dateStr];
                
                let shiftClass = '';
                if (shift) {
                    if (shift.type === 'regular') {
                        if (shift.paid) shiftClass = 'shift-paid';
                        else if (shift.done) shiftClass = 'shift-done';
                        else shiftClass = 'shift-regular';
                    } else if (shift.type === 'extra') {
                        if (shift.paid) shiftClass = 'shift-paid-extra';
                        else if (shift.done) shiftClass = 'shift-done-extra';
                        else shiftClass = 'shift-extra';
                    } else if (shift.type === 'dayoff') {
                        shiftClass = 'shift-dayoff';
                    } else if (shift.type === 'problem') {
                        shiftClass = 'shift-problem';
                    }
                }
                
                html += `
                    <div class="calendar-day" data-date="${dateStr}">
                        <div class="day-number">${day}</div>
                        ${shift ? `<div class="shift-marker ${shiftClass}"></div>` : ''}
                    </div>
                `;
            }
            
            const totalCells = 35;
            const filledCells = startDay + totalDays;
            for (let i = filledCells; i < totalCells; i++) {
                html += `<div class="calendar-day"></div>`;
            }
            
            container.innerHTML = html;
        }
        
        // === ШАБЛОН ПОСТОВ ===
        function renderPostsTemplate() {
            const container = app.getElement('posts-template');
            if (!container) return;
            
            let html = '';
            defaultPosts.forEach((item, index) => {
                html += `
                    <tr>
                        <td>${item.number}</td>
                        <td>${item.post}</td>
                        <td>${item.time}</td>
                        <td>
                            <button class="btn-small edit-template-btn" data-index="${index}"><i class="fas fa-edit"></i></button>
                            <button class="btn-small btn-danger delete-template-btn" data-index="${index}"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            });
            
            container.innerHTML = html;
            
            document.querySelectorAll('.edit-template-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    editTemplatePost(index);
                });
            });
            
            document.querySelectorAll('.delete-template-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    deleteTemplatePost(index);
                });
            });
        }
        
        function editTemplatePost(index) {
            const post = defaultPosts[index];
            const newNumber = prompt('Измените номер поста:', post.number);
            if (newNumber !== null) {
                const newPost = prompt('Измените название поста:', post.post);
                if (newPost !== null) {
                    const newTime = prompt('Измените время (формат ЧЧ:ММ):', post.time);
                    if (newTime !== null) {
                        defaultPosts[index] = { number: newNumber, post: newPost, time: newTime };
                        renderPostsTemplate();
                        alert('Шаблон обновлен!');
                    }
                }
            }
        }
        
        function deleteTemplatePost(index) {
            if (confirm('Удалить этот пост из шаблона?')) {
                defaultPosts.splice(index, 1);
                renderPostsTemplate();
                alert('Пост удален из шаблона!');
            }
        }
        
        // === ЗАГРУЗКА ПОСТОВ ПО ДАТЕ ===
        app.safeAddEventListener('load-posts-btn', 'click', async function() {
            const dateInput = app.getElement('posts-date');
            if (!dateInput || !dateInput.value) {
                alert('Выберите дату');
                return;
            }
            
            await loadPostsForDate(dateInput.value, true);
        });
        
        app.safeAddEventListener('create-template-btn', 'click', async function() {
            const dateInput = app.getElement('posts-date');
            if (!dateInput || !dateInput.value) {
                alert('Выберите дату');
                return;
            }
            
            if (!confirm(`Создать шаблон постов для даты ${dateInput.value}?`)) return;
            
            await createPostsFromTemplate(dateInput.value);
        });
        
        async function loadPostsForDate(date, isAdminView = false) {
            try {
                const snapshot = await db.collection('posts')
                    .where('date', '==', date)
                    .get();
                
                postsData = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    let guardDisplayName = data.guardName || '';
                    if (guardDisplayName) {
                        const nameParts = guardDisplayName.split(' ');
                        if (nameParts.length >= 2) {
                            guardDisplayName = `${nameParts[0]} ${nameParts.slice(1).join(' ')}`;
                        }
                    }
                    
                    postsData.push({ 
                        id: doc.id, 
                        ...data,
                        guardDisplayName: guardDisplayName
                    });
                });
                
                postsData.sort((a, b) => {
                    const orderA = a.order || 999;
                    const orderB = b.order || 999;
                    return orderA - orderB;
                });
                
                if (isAdminView) {
                    renderAdminPostsTable(date);
                } else {
                    renderUserPostsTable(date);
                }
            } catch (error) {
                console.error('Ошибка загрузки постов:', error);
                if (isAdminView) {
                    const container = app.getElement('posts-admin-container');
                    if (container) {
                        container.innerHTML = `<div class="error">Ошибка загрузки: ${error.message}</div>`;
                    }
                }
            }
        }
        
        function renderAdminPostsTable(date) {
            const container = app.getElement('posts-admin-container');
            if (!container) return;
            
            if (postsData.length === 0) {
                container.innerHTML = `
                    <div class="message">
                        <p>Нет постов на дату ${date}</p>
                        <button id="create-posts-btn" class="btn-success" style="margin-top: 10px;"><i class="fas fa-plus"></i> Создать из шаблона</button>
                    </div>
                `;
                
                app.safeAddEventListener('create-posts-btn', 'click', async function() {
                    await createPostsFromTemplate(date);
                });
                return;
            }
            
            const dateObj = new Date(date);
            const formattedDate = dateObj.toLocaleDateString('ru-RU');
            
            let html = `
                <h3>Посты на дату: ${formattedDate}</h3>
                <div class="table-responsive">
                    <table class="posts-table">
                        <thead>
                            <tr>
                                <th>№</th>
                                <th>Пост</th>
                                <th>Время</th>
                                <th>Охранник</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            postsData.forEach((post) => {
                html += `
                    <tr class="post-row" data-id="${post.id}">
                        <td>
                            <input type="text" value="${post.number || ''}" class="number-input" placeholder="№" style="width: 60px;">
                        </td>
                        <td>
                            <input type="text" value="${post.post || ''}" class="post-input" placeholder="Название поста" style="width: 100%;">
                        </td>
                        <td>
                            <input type="time" value="${post.time || '08:00'}" class="time-input">
                        </td>
                        <td>
                            ${renderUserSelectForPosts(post.guardId)}
                        </td>
                        <td class="post-controls">
                            <button class="btn-success save-post-btn btn-small"><i class="fas fa-save"></i></button>
                            <button class="btn-danger delete-post-btn btn-small"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
                <div style="margin-top: 1rem;">
                    <button id="add-new-post-btn" class="btn-secondary"><i class="fas fa-plus"></i> Добавить новую строку</button>
                    <button id="save-all-posts-btn" class="btn-success" style="margin-left: 10px;"><i class="fas fa-save"></i> Сохранить все</button>
                </div>
            `;
            
            container.innerHTML = html;
            
            app.safeAddEventListener('add-new-post-btn', 'click', function() {
                addNewPostRowToTable(date);
            });
            
            app.safeAddEventListener('save-all-posts-btn', 'click', function() {
                saveAllPosts(date);
            });
            
            document.querySelectorAll('.save-post-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const row = this.closest('.post-row');
                    savePostRow(row, date);
                });
            });
            
            document.querySelectorAll('.delete-post-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const row = this.closest('.post-row');
                    deletePostRow(row, date);
                });
            });
        }
        
        function renderUserSelectForPosts(selectedId = '') {
            let html = `<select class="guard-select" style="width: 100%;">`;
            html += `<option value="">Не назначен</option>`;
            allUsers.forEach(user => {
                if (user.role !== 'admin') {
                    html += `<option value="${user.id}" ${user.id === selectedId ? 'selected' : ''}>${user.displayName}</option>`;
                }
            });
            html += `</select>`;
            return html;
        }
        
        async function createPostsFromTemplate(date) {
            try {
                const oldPosts = await db.collection('posts')
                    .where('date', '==', date)
                    .get();
                
                const batch = db.batch();
                oldPosts.forEach(doc => {
                    batch.delete(doc.ref);
                });
                
                for (let i = 0; i < defaultPosts.length; i++) {
                    const post = defaultPosts[i];
                    const postRef = db.collection('posts').doc();
                    
                    const order = i + 1;
                    
                    batch.set(postRef, {
                        date: date,
                        number: post.number,
                        post: post.post,
                        guardId: '',
                        guardName: '',
                        time: post.time,
                        order: order,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                
                await batch.commit();
                alert('Шаблон постов создан в правильном порядке!');
                await loadPostsForDate(date, true);
                
            } catch (error) {
                alert('Ошибка создания шаблона: ' + error.message);
            }
        }
        
        async function addNewPostRowToTable(date) {
            try {
                let maxOrder = 0;
                postsData.forEach(post => {
                    if (post.order !== undefined && post.order > maxOrder) {
                        maxOrder = post.order;
                    }
                });
                
                const postRef = await db.collection('posts').add({
                    date: date,
                    number: '',
                    post: 'Новый пост',
                    guardId: '',
                    guardName: '',
                    time: '08:00',
                    order: maxOrder + 1,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                await loadPostsForDate(date, true);
            } catch (error) {
                alert('Ошибка создания поста: ' + error.message);
            }
        }
        
        async function savePostRow(row, date) {
            const postId = row.getAttribute('data-id');
            const numberInput = row.querySelector('.number-input');
            const postInput = row.querySelector('.post-input');
            const guardSelect = row.querySelector('.guard-select');
            const timeInput = row.querySelector('.time-input');
            
            if (!postId || !numberInput || !postInput || !guardSelect || !timeInput) return;
            
            const number = numberInput.value.trim();
            const post = postInput.value.trim();
            const guardId = guardSelect.value;
            const time = timeInput.value;
            
            if (!post) {
                alert('Введите название поста');
                return;
            }
            
            const guard = allUsers.find(u => u.id === guardId);
            let guardName = guard ? guard.displayName : '';
            
            if (guard && guard.lastName && guard.firstName) {
                guardName = `${guard.lastName} ${guard.firstName}`;
            }
            
            const existingPost = postsData.find(p => p.id === postId);
            const order = existingPost ? existingPost.order : (postsData.length + 1);
            
            try {
                await db.collection('posts').doc(postId).update({
                    number: number,
                    post: post,
                    guardId: guardId,
                    guardName: guardName,
                    time: time,
                    order: order,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                alert('Пост сохранен!');
            } catch (error) {
                alert('Ошибка сохранения: ' + error.message);
            }
        }
        
        async function saveAllPosts(date) {
            const rows = document.querySelectorAll('.post-row');
            let hasErrors = false;
            
            for (const row of rows) {
                const postId = row.getAttribute('data-id');
                const numberInput = row.querySelector('.number-input');
                const postInput = row.querySelector('.post-input');
                const guardSelect = row.querySelector('.guard-select');
                const timeInput = row.querySelector('.time-input');
                
                if (!postId || !numberInput || !postInput || !guardSelect || !timeInput) continue;
                
                const number = numberInput.value.trim();
                const post = postInput.value.trim();
                const guardId = guardSelect.value;
                const time = timeInput.value;
                
                if (!post) {
                    alert('Заполните название поста во всех строках');
                    hasErrors = true;
                    break;
                }
                
                const guard = allUsers.find(u => u.id === guardId);
                let guardName = guard ? guard.displayName : '';
                
                if (guard && guard.lastName && guard.firstName) {
                    guardName = `${guard.lastName} ${guard.firstName}`;
                }
                
                const existingPost = postsData.find(p => p.id === postId);
                const order = existingPost ? existingPost.order : (postsData.length + 1);
                
                try {
                    await db.collection('posts').doc(postId).update({
                        number: number,
                        post: post,
                        guardId: guardId,
                        guardName: guardName,
                        time: time,
                        order: order,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } catch (error) {
                    alert('Ошибка сохранения: ' + error.message);
                    hasErrors = true;
                    break;
                }
            }
            
            if (!hasErrors) {
                alert('Все посты сохранены!');
                await loadPostsForDate(date, true);
            }
        }
        
        async function deletePostRow(row, date) {
            const postId = row.getAttribute('data-id');
            if (!postId) return;
            
            if (!confirm('Удалить этот пост?')) return;
            
            try {
                await db.collection('posts').doc(postId).delete();
                await loadPostsForDate(date, true);
            } catch (error) {
                alert('Ошибка удаления: ' + error.message);
            }
        }
        
        // === ПОСТОВАЯ ДЛЯ ПОЛЬЗОВАТЕЛЯ ===
        app.safeAddEventListener('load-user-posts-btn', 'click', async function() {
            const dateInput = app.getElement('user-posts-date');
            if (!dateInput || !dateInput.value) {
                alert('Выберите дату');
                return;
            }
            
            await loadPostsForDate(dateInput.value, false);
        });
        
        function renderUserPostsTable(date) {
            const container = app.getElement('posts-user-container');
            if (!container) return;
            
            if (postsData.length === 0) {
                container.innerHTML = `
                    <div class="message">
                        <p>Нет постов на выбранную дату ${date}</p>
                    </div>
                `;
                return;
            }
            
            const dateObj = new Date(date);
            const formattedDate = dateObj.toLocaleDateString('ru-RU');
            
            let html = `
                <h3>Посты на дату: ${formattedDate}</h3>
                <div class="table-responsive">
                    <table class="posts-table">
                        <thead>
                            <tr>
                                <th>№</th>
                                <th>Пост</th>
                                <th>Время</th>
                                <th>Охранник</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            postsData.forEach((post) => {
                html += `
                    <tr>
                        <td>${post.number || ''}</td>
                        <td>${post.post || ''}</td>
                        <td>${post.time || ''}</td>
                        <td>${post.guardDisplayName || post.guardName || 'Не назначен'}</td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        // === ОБНОВЛЕНИЕ СТАТИСТИКИ ===
        function updateUserStats() {
            if (!currentUser) return;
            
            const user = allUsers.find(u => u.id === currentUser.uid);
            if (!user) return;
            
            const rate = user.rate || 0;
            const shifts = shiftsMap[currentUser.uid] || {};
            
            let regularCount = 0;
            let extraCount = 0;
            let pendingAmount = 0;
            let paidAmount = 0;
            
            Object.values(shifts).forEach(shift => {
                if (shift.type === 'regular') {
                    if (shift.done && !shift.paid) {
                        regularCount++;
                        pendingAmount += rate;
                    } else if (shift.paid) {
                        paidAmount += rate;
                    }
                } else if (shift.type === 'extra') {
                    if (shift.done && !shift.paid) {
                        extraCount++;
                        pendingAmount += rate + 100;
                    } else if (shift.paid) {
                        paidAmount += rate + 100;
                    }
                }
            });
            
            const pendingTable = app.getElement('pending-payments');
            const pendingTotal = app.getElement('pending-total');
            
            if (pendingTable) {
                if (regularCount === 0 && extraCount === 0) {
                    pendingTable.innerHTML = '<tr><td colspan="4">Нет ожидающих выплат</td></tr>';
                } else {
                    pendingTable.innerHTML = '';
                    if (regularCount > 0) {
                        pendingTable.innerHTML += `
                            <tr>
                                <td>Обычные смены</td>
                                <td>${regularCount}</td>
                                <td>${rate} ₽</td>
                                <td>${regularCount * rate} ₽</td>
                            </tr>
                        `;
                    }
                    if (extraCount > 0) {
                        pendingTable.innerHTML += `
                            <tr>
                                <td>Подработки</td>
                                <td>${extraCount}</td>
                                <td>${rate + 100} ₽</td>
                                <td>${extraCount * (rate + 100)} ₽</td>
                            </tr>
                        `;
                    }
                }
            }
            
            if (pendingTotal) pendingTotal.textContent = `${pendingAmount} ₽`;
            
            const userName = app.getElement('user-full-name');
            const userPosition = app.getElement('user-position');
            const userRate = app.getElement('user-rate');
            const userEmail = app.getElement('user-email');
            
            if (userName) {
                if (user.lastName && user.firstName) {
                    userName.textContent = `${user.lastName} ${user.firstName}`;
                } else {
                    userName.textContent = user.fullName || user.email || 'Имя не указано';
                }
            }
            if (userPosition) userPosition.textContent = user.role === 'admin' ? 'Администратор' : 'Охранник';
            if (userRate) userRate.textContent = `${rate} ₽`;
            if (userEmail) userEmail.textContent = user.email;
        }
        
        // === РАСЧЕТ ВЫПЛАТ ===
        app.safeAddEventListener('calculate-payment-btn', 'click', async () => {
            const paymentUser = app.getElement('payment-user');
            const periodFrom = app.getElement('period-from');
            const periodTo = app.getElement('period-to');
            const bonusAmount = app.getElement('bonus-amount');
            const penaltyAmount = app.getElement('penalty-amount');
            const bonusNote = app.getElement('bonus-note');
            
            if (!paymentUser || !periodFrom || !periodTo || !bonusAmount || !penaltyAmount || !bonusNote) return;
            
            const userId = paymentUser.value;
            const fromDate = periodFrom.value;
            const toDate = periodTo.value;
            const bonus = parseInt(bonusAmount.value) || 0;
            const penalty = parseInt(penaltyAmount.value) || 0;
            const note = bonusNote.value;
            
            if (!userId || !fromDate || !toDate) {
                alert('Заполните все поля');
                return;
            }
            
            const user = allUsers.find(u => u.id === userId);
            if (!user) return;
            
            const rate = user.rate || 0;
            
            try {
                const shifts = await db.collection('shifts')
                    .where('userId', '==', userId)
                    .where('date', '>=', fromDate)
                    .where('date', '<=', toDate)
                    .get();
                
                let regularCount = 0;
                let extraCount = 0;
                let totalAmount = 0;
                const batch = db.batch();
                
                shifts.forEach(doc => {
                    const data = doc.data();
                    if (data.done && !data.paid) {
                        if (data.type === 'regular') {
                            regularCount++;
                            totalAmount += rate;
                        } else if (data.type === 'extra') {
                            extraCount++;
                            totalAmount += rate + 100;
                        }
                        
                        batch.update(doc.ref, { 
                            paid: true,
                            paidAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                });
                
                if (regularCount === 0 && extraCount === 0) {
                    alert('Нет смен для выплаты в выбранном периоде');
                    return;
                }
                
                const finalAmount = totalAmount + bonus - penalty;
                
                const paymentRef = db.collection('salary_payments').doc();
                await paymentRef.set({
                    userId: userId,
                    userName: user.displayName || user.email,
                    periodFrom: fromDate,
                    periodTo: toDate,
                    regularShifts: regularCount,
                    extraShifts: extraCount,
                    baseAmount: totalAmount,
                    bonus: bonus,
                    penalty: penalty,
                    bonusNote: note,
                    totalAmount: finalAmount,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    adminId: currentUser.uid
                });
                
                await batch.commit();
                
                await loadUsers();
                if (userId === currentUser?.uid) {
                    updateUserStats();
                    await loadPaymentHistory(userId);
                }
                
                bonusAmount.value = '0';
                penaltyAmount.value = '0';
                bonusNote.value = '';
                
                const resultDiv = app.getElement('calculation-result');
                if (resultDiv) {
                    resultDiv.innerHTML = `
                        <div class="success">
                            <strong>Выплата создана!</strong><br>
                            Охранник: ${user.displayName || user.email}<br>
                            Период: ${fromDate} - ${toDate}<br>
                            Обычных: ${regularCount} × ${rate} ₽ = ${regularCount * rate} ₽<br>
                            Подработок: ${extraCount} × ${rate + 100} ₽ = ${extraCount * (rate + 100)} ₽<br>
                            Премия: +${bonus} ₽<br>
                            Удержание: -${penalty} ₽<br>
                            <strong>Итого: ${finalAmount} ₽</strong>
                        </div>
                    `;
                }
                
            } catch (error) {
                alert('Ошибка: ' + error.message);
            }
        });
        
        // === ИСТОРИЯ ВЫПЛАТ (ИСПРАВЛЕННАЯ) ===
        async function loadPaymentHistory(userId) {
            try {
                const snapshot = await db.collection('salary_payments')
                    .where('userId', '==', userId)
                    .orderBy('createdAt', 'desc')
                    .get();
                
                const container = app.getElement('payments-history');
                if (!container) return;
                
                if (snapshot.empty) {
                    container.innerHTML = '<tr><td colspan="9">Нет выплат</td></tr>';
                    return;
                }
                
                let html = '';
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const date = data.createdAt?.toDate ? 
                        data.createdAt.toDate().toLocaleDateString('ru-RU', {
                            day: '2-digit',
                            month: '2-digit',
                            year: 'numeric'
                        }) : 'Дата неизвестна';
                    
                    html += `
                        <tr>
                            <td>${date}</td>
                            <td>${data.periodFrom}<br>${data.periodTo}</td>
                            <td>${data.regularShifts || 0}</td>
                            <td>${data.extraShifts || 0}</td>
                            <td>${data.baseAmount || 0} ₽</td>
                            <td>${data.bonus || 0} ₽</td>
                            <td>${data.penalty || 0} ₽</td>
                            <td>${data.bonusNote || ''}</td>
                            <td><strong>${data.totalAmount || 0} ₽</strong></td>
                        </tr>
                    `;
                });
                container.innerHTML = html;
            } catch (error) {
                console.error('Ошибка загрузки истории выплат:', error);
                
                // Если ошибка индекса, пробуем без сортировки
                if (error.message.includes('index')) {
                    try {
                        const snapshot = await db.collection('salary_payments')
                            .where('userId', '==', userId)
                            .get();
                        
                        const container = app.getElement('payments-history');
                        if (!container) return;
                        
                        if (snapshot.empty) {
                            container.innerHTML = '<tr><td colspan="9">Нет выплат</td></tr>';
                            return;
                        }
                        
                        let payments = [];
                        snapshot.forEach(doc => {
                            payments.push({ id: doc.id, ...doc.data() });
                        });
                        
                        // Сортируем вручную
                        payments.sort((a, b) => {
                            const dateA = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(0);
                            const dateB = b.createdAt?.toDate ? b.createdAt.toDate() : new Date(0);
                            return dateB - dateA;
                        });
                        
                        let html = '';
                        payments.forEach(data => {
                            const date = data.createdAt?.toDate ? 
                                data.createdAt.toDate().toLocaleDateString('ru-RU', {
                                    day: '2-digit',
                                    month: '2-digit',
                                    year: 'numeric'
                                }) : 'Дата неизвестна';
                            
                            html += `
                                <tr>
                                    <td>${date}</td>
                                    <td>${data.periodFrom}<br>${data.periodTo}</td>
                                    <td>${data.regularShifts || 0}</td>
                                    <td>${data.extraShifts || 0}</td>
                                    <td>${data.baseAmount || 0} ₽</td>
                                    <td>${data.bonus || 0} ₽</td>
                                    <td>${data.penalty || 0} ₽</td>
                                    <td>${data.bonusNote || ''}</td>
                                    <td><strong>${data.totalAmount || 0} ₽</strong></td>
                                </tr>
                            `;
                        });
                        container.innerHTML = html;
                    } catch (innerError) {
                        console.error('Вторичная ошибка загрузки истории выплат:', innerError);
                        const container = app.getElement('payments-history');
                        if (container) {
                            container.innerHTML = `<tr><td colspan="9">Ошибка загрузки истории выплат. Создайте индекс в Firebase Console.</td></tr>`;
                        }
                    }
                }
            }
        }
        
        // === ИНИЦИАЛИЗАЦИЯ ===
        function init() {
            initTabs();
            
            app.safeAddEventListener('nav-home', 'click', (e) => {
                e.preventDefault();
                app.showSection('welcome-section');
            });
            app.safeAddEventListener('nav-login', 'click', (e) => {
                e.preventDefault();
                app.showSection('login-section');
            });
            app.safeAddEventListener('nav-admin', 'click', (e) => {
                e.preventDefault();
                app.showSection('admin-section');
            });
            app.safeAddEventListener('nav-user', 'click', (e) => {
                e.preventDefault();
                app.showSection('user-section');
            });
            app.safeAddEventListener('nav-logout', 'click', () => {
                auth.signOut();
            });
            
            app.safeAddEventListener('go-to-login', 'click', (e) => {
                e.preventDefault();
                app.showSection('login-section');
            });
            
            const monthSelect = app.getElement('selected-month');
            const yearInput = app.getElement('selected-year');
            
            if (monthSelect) {
                monthSelect.value = currentMonth;
                monthSelect.addEventListener('change', async () => {
                    if (isAdmin && document.getElementById('tab-shifts-admin')?.classList.contains('active')) {
                        await loadAllShiftsForAdmin();
                    }
                });
            }
            if (yearInput) {
                yearInput.value = currentYear;
                yearInput.addEventListener('change', async () => {
                    if (isAdmin && document.getElementById('tab-shifts-admin')?.classList.contains('active')) {
                        await loadAllShiftsForAdmin();
                    }
                });
            }
            
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            const periodFrom = app.getElement('period-from');
            const periodTo = app.getElement('period-to');
            
            if (periodFrom) periodFrom.valueAsDate = firstDay;
            if (periodTo) periodTo.valueAsDate = today;
            
            const postsDate = app.getElement('posts-date');
            const userPostsDate = app.getElement('user-posts-date');
            if (postsDate) postsDate.valueAsDate = today;
            if (userPostsDate) userPostsDate.valueAsDate = today;
            
            renderPostsTemplate();
            
            app.showSection('welcome-section');
        }
        
        // === ЗАГРУЗКА СМЕН ДЛЯ ПОЛЬЗОВАТЕЛЯ ===
        async function loadShiftsForUser(userId) {
            try {
                const snapshot = await db.collection('shifts')
                    .where('userId', '==', userId)
                    .get();
                
                shiftsMap[userId] = {};
                snapshot.forEach(doc => {
                    const data = doc.data();
                    shiftsMap[userId][data.date] = {
                        type: data.type,
                        done: data.done || false,
                        paid: data.paid || false
                    };
                });
            } catch (error) {
                console.error('Ошибка загрузки смен:', error);
            }
        }
        
        // === ОБРАБОТЧИК АУТЕНТИФИКАЦИИ ===
        auth.onAuthStateChanged(async (user) => {
            currentUser = user;
            
            if (user) {
                await loadUsers();
                
                const userDoc = await db.collection('users').doc(user.uid).get();
                isAdmin = userDoc.exists && userDoc.data().role === 'admin';
                
                if (isAdmin) {
                    app.showSection('admin-section');
                    await loadAllShiftsForAdmin();
                } else {
                    await loadShiftsForUser(user.uid);
                    updateUserStats();
                    renderUserCalendar();
                    await loadPaymentHistory(user.uid);
                    app.showSection('user-section');
                }
                
                app.updateNavigation();
            } else {
                isAdmin = false;
                app.showSection('welcome-section');
                app.updateNavigation();
            }
        });
        
        // ЗАПУСК
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
