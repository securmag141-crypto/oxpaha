<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Личный кабинет Охранника</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary-color: #64ffda;
            --secondary-color: #0a192f;
            --accent-color: #27ae60;
            --error-color: #e74c3c;
            --text-color: #ffffff;
            --bg-color: #0d1b2a;
            --table-bg: #1b263b;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        header {
            background: linear-gradient(135deg, var(--secondary-color), var(--table-bg));
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        nav {
            display: flex;
            gap: 1rem;
        }

        .nav-btn {
            background: var(--primary-color);
            color: var(--secondary-color);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .nav-btn:hover {
            background: #52e3c2;
        }

        main {
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        section {
            display: none;
            margin-bottom: 2rem;
        }

        section.active {
            display: block;
        }

        .tabs {
            display: flex;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--primary-color);
        }

        .tab {
            background: var(--table-bg);
            color: var(--text-color);
            border: none;
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            transition: background 0.3s;
            position: relative;
        }

        .tab.active {
            background: var(--primary-color);
            color: var(--secondary-color);
        }

        .tab:focus {
            outline: 2px solid var(--primary-color);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--table-bg);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        th, td {
            padding: 0.75rem;
            text-align: center;
            border: 1px solid #2c3e50;
        }

        th {
            background: var(--secondary-color);
            font-weight: 500;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .shifts-admin-table {
            max-height: 70vh;
            overflow: auto;
        }

        .shifts-admin-table th:nth-child(n+3) {
            min-width: 60px;
            height: 40px;
        }

        .shift-cell {
            cursor: pointer;
            transition: background 0.2s;
        }

        .shift-cell:hover {
            opacity: 0.8;
        }

        .shift-regular {
            background: var(--accent-color);
        }

        .shift-extra {
            background: #f39c12;
        }

        .shift-dayoff {
            background: #95a5a6;
        }

        .shift-problem {
            background: var(--error-color);
        }

        .shift-done {
            background: #9b59b6;
            pointer-events: none;
        }

        .shift-paid {
            background: #34495e;
            pointer-events: none;
        }

        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .calendar-day {
            background: var(--table-bg);
            padding: 1rem;
            border-radius: 5px;
            min-height: 80px;
            position: relative;
        }

        .calendar-day.today {
            border: 2px solid var(--primary-color);
        }

        .shift-marker {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        form {
            background: var(--table-bg);
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        input, select, textarea {
            width: 100%;
            padding: 0.5rem;
            margin-bottom: 1rem;
            background: var(--secondary-color);
            color: var(--text-color);
            border: 1px solid #34495e;
            border-radius: 5px;
        }

        input:focus, select:focus, textarea:focus {
            outline: 2px solid var(--primary-color);
        }

        button {
            background: var(--primary-color);
            color: var(--secondary-color);
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
            font-weight: 500;
        }

        button:hover {
            background: #52e3c2;
        }

        button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }

        .btn-danger {
            background: var(--error-color);
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .legend {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 3px;
        }

        footer {
            text-align: center;
            padding: 1rem;
            background: var(--secondary-color);
            color: #95a5a6;
        }

        @media (max-width: 768px) {
            .shifts-admin-table {
                font-size: 0.8rem;
            }

            .shifts-admin-table th:nth-child(n+3) {
                min-width: 40px;
            }

            .calendar {
                grid-template-columns: repeat(7, 1fr);
                font-size: 0.9rem;
            }

            nav {
                flex-direction: column;
                gap: 0.5rem;
            }
        }

        @media (max-width: 480px) {
            main {
                padding: 1rem;
            }

            .tabs {
                flex-direction: column;
            }

            .tab {
                padding: 0.5rem;
            }
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-color);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #52e3c2;
        }

        /* Tooltip styles */
        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 120px;
            background-color: var(--secondary-color);
            color: var(--text-color);
            text-align: center;
            border-radius: 5px;
            padding: 5px 0;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -60px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        /* Error message styles */
        .error-message {
            color: var(--error-color);
            background: rgba(231, 76, 60, 0.1);
            padding: 1rem;
            border-radius: 5px;
            margin-bottom: 1rem;
            border-left: 4px solid var(--error-color);
        }

        .success-message {
            color: var(--accent-color);
            background: rgba(39, 174, 96, 0.1);
            padding: 1rem;
            border-radius: 5px;
            margin-bottom: 1rem;
            border-left: 4px solid var(--accent-color);
        }

        .controls {
            display: flex;
            gap: 1rem;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .post-item {
            background: var(--table-bg);
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .post-item h3 {
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">Личный кабинет Охранника</div>
        <nav>
            <button class="nav-btn" id="logout-btn" style="display: none;">Выйти</button>
        </nav>
    </header>

    <main>
        <section id="welcome" class="active">
            <h1>Добро пожаловать!</h1>
            <p>Пожалуйста, войдите в систему для доступа к личному кабинету.</p>
        </section>

        <section id="login">
            <form id="login-form">
                <h2>Вход в систему</h2>
                <div class="error-message" id="login-error" style="display: none;"></div>
                <input type="email" id="login-email" placeholder="Email" required aria-label="Email">
                <input type="password" id="login-password" placeholder="Пароль" minlength="6" required aria-label="Пароль">
                <button type="submit" id="login-submit">Войти <span class="loading" id="login-loading" style="display: none;"></span></button>
            </form>
        </section>

        <section id="admin" style="display: none;">
            <div class="tabs">
                <button class="tab active" data-tab="admin-shifts" aria-selected="true">Смены</button>
                <button class="tab" data-tab="admin-payments">Выплаты</button>
                <button class="tab" data-tab="admin-posts">Посты</button>
                <button class="tab" data-tab="admin-employees">Сотрудники</button>
            </div>

            <div id="admin-shifts" class="tab-content active">
                <h2>Управление сменами</h2>
                <div class="success-message" id="shifts-success" style="display: none;"></div>
                <div class="error-message" id="shifts-error" style="display: none;"></div>
                <div class="legend">
                    <div class="legend-item"><div class="legend-color shift-regular"></div><span>Обычная смена</span></div>
                    <div class="legend-item"><div class="legend-color shift-extra"></div><span>Дополнительная смена</span></div>
                    <div class="legend-item"><div class="legend-color shift-dayoff"></div><span>Выходной</span></div>
                    <div class="legend-item"><div class="legend-color shift-problem"></div><span>Проблема</span></div>
                    <div class="legend-item"><div class="legend-color shift-done"></div><span>Выполнена</span></div>
                    <div class="legend-item"><div class="legend-color shift-paid"></div><span>Оплачена</span></div>
                </div>
                <div class="controls">
                    <select id="selected-month-admin" aria-label="Месяц">
                        <option value="0">Январь</option><option value="1">Февраль</option><option value="2">Март</option>
                        <option value="3">Апрель</option><option value="4">Май</option><option value="5">Июнь</option>
                        <option value="6">Июль</option><option value="7">Август</option><option value="8">Сентябрь</option>
                        <option value="9">Октябрь</option><option value="10">Ноябрь</option><option value="11">Декабрь</option>
                    </select>
                    <select id="selected-year-admin" aria-label="Год"></select>
                    <button id="save-all-shifts-btn">Сохранить все <span class="loading" style="display: none;"></span></button>
                    <button id="export-shifts-btn">Экспорт CSV</button>
                    <label for="import-csv" style="cursor: pointer; padding: 0.5rem 1rem; background: var(--primary-color); border-radius: 5px; color: var(--secondary-color);">Импорт CSV</label>
                    <input type="file" id="import-csv" accept=".csv" style="display: none;">
                </div>
                <div class="shifts-admin-table" id="shifts-admin-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Сотрудник</th>
                                <th>Пост</th>
                                <th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th>
                                <th>8</th><th>9</th><th>10</th><th>11</th><th>12</th><th>13</th><th>14</th>
                                <th>15</th><th>16</th><th>17</th><th>18</th><th>19</th><th>20</th><th>21</th>
                                <th>22</th><th>23</th><th>24</th><th>25</th
<th>26</th><th>27</th><th>28</th><th>29</th><th>30</th><th>31</th>
                            </tr>
                        </thead>
                        <tbody id="shifts-admin-tbody"></tbody>
                    </table>
                </div>
            </div>

            <div id="admin-payments" class="tab-content">
                <h2>Управление выплатами</h2>
                <div class="success-message" id="payments-success" style="display: none;"></div>
                <div class="error-message" id="payments-error" style="display: none;"></div>
                <div class="controls">
                    <select id="selected-month-payments" aria-label="Месяц">
                        <option value="0">Январь</option><option value="1">Февраль</option><option value="2">Март</option>
                        <option value="3">Апрель</option><option value="4">Май</option><option value="5">Июнь</option>
                        <option value="6">Июль</option><option value="7">Август</option><option value="8">Сентябрь</option>
                        <option value="9">Октябрь</option><option value="10">Ноябрь</option><option value="11">Декабрь</option>
                    </select>
                    <select id="selected-year-payments" aria-label="Год"></select>
                    <button id="calculate-payments-btn">Рассчитать выплаты <span class="loading" style="display: none;"></span></button>
                    <button id="export-payments-btn">Экспорт CSV</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Сотрудник</th>
                            <th>Обычные смены</th>
                            <th>Дополнительные смены</th>
                            <th>Итого часов</th>
                            <th>Ставка за час</th>
                            <th>Итого к выплате</th>
                            <th>Статус</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody id="payments-tbody"></tbody>
                </table>
            </div>

            <div id="admin-posts" class="tab-content">
                <h2>Управление постами</h2>
                <div class="success-message" id="posts-success" style="display: none;"></div>
                <div class="error-message" id="posts-error" style="display: none;"></div>
                <form id="add-post-form">
                    <input type="text" id="post-name" placeholder="Название поста" required aria-label="Название поста">
                    <textarea id="post-description" placeholder="Описание поста" rows="3" aria-label="Описание поста"></textarea>
                    <button type="submit">Добавить пост <span class="loading" style="display: none;"></span></button>
                </form>
                <div id="posts-list"></div>
            </div>

            <div id="admin-employees" class="tab-content">
                <h2>Управление сотрудниками</h2>
                <div class="success-message" id="employees-success" style="display: none;"></div>
                <div class="error-message" id="employees-error" style="display: none;"></div>
                <form id="add-employee-form">
                    <input type="email" id="employee-email" placeholder="Email сотрудника" required aria-label="Email сотрудника">
                    <input type="text" id="employee-name" placeholder="Имя сотрудника" required aria-label="Имя сотрудника">
                    <input type="number" id="employee-rate" placeholder="Ставка за час" step="0.01" min="0" required aria-label="Ставка за час">
                    <select id="employee-post" required aria-label="Пост">
                        <option value="">Выберите пост</option>
                    </select>
                    <button type="submit">Добавить сотрудника <span class="loading" style="display: none;"></span></button>
                </form>
                <table>
                    <thead>
                        <tr>
                            <th>Имя</th>
                            <th>Email</th>
                            <th>Ставка</th>
                            <th>Пост</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody id="employees-tbody"></tbody>
                </table>
            </div>
        </section>
        <section id="employee" style="display: none;">
            <div class="tabs">
                <button class="tab active" data-tab="employee-shifts" aria-selected="true">Мои смены</button>
                <button class="tab" data-tab="employee-payments">Мои выплаты</button>
                <button class="tab" data-tab="employee-profile">Профиль</button>
            </div>

            <div id="employee-shifts" class="tab-content active">
                <h2>Мои смены</h2>
                <div class="success-message" id="employee-shifts-success" style="display: none;"></div>
                <div class="error-message" id="employee-shifts-error" style="display: none;"></div>
                <div class="legend">
                    <div class="legend-item"><div class="legend-color shift-regular"></div><span>Обычная смена</span></div>
                    <div class="legend-item"><div class="legend-color shift-extra"></div><span>Дополнительная смена</span></div>
                    <div class="legend-item"><div class="legend-color shift-dayoff"></div><span>Выходной</span></div>
                    <div class="legend-item"><div class="legend-color shift-problem"></div><span>Проблема</span></div>
                    <div class="legend-item"><div class="legend-color shift-done"></div><span>Выполнена</span></div>
                    <div class="legend-item"><div class="legend-color shift-paid"></div><span>Оплачена</span></div>
                </div>
                <div class="controls">
                    <select id="selected-month-employee" aria-label="Месяц">
                        <option value="0">Январь</option><option value="1">Февраль</option><option value="2">Март</option>
                        <option value="3">Апрель</option><option value="4">Май</option><option value="5">Июнь</option>
                        <option value="6">Июль</option><option value="7">Август</option><option value="8">Сентябрь</option>
                        <option value="9">Октябрь</option><option value="10">Ноябрь</option><option value="11">Декабрь</option>
                    </select>
                    <select id="selected-year-employee" aria-label="Год"></select>
                    <button id="export-employee-shifts-btn">Экспорт CSV</button>
                </div>
                <div class="calendar" id="employee-calendar"></div>
            </div>

            <div id="employee-payments" class="tab-content">
                <h2>Мои выплаты</h2>
                <div class="success-message" id="employee-payments-success" style="display: none;"></div>
                <div class="error-message" id="employee-payments-error" style="display: none;"></div>
                <div class="controls">
                    <select id="selected-month-employee-payments" aria-label="Месяц">
                        <option value="0">Январь</option><option value="1">Февраль</option><option value="2">Март</option>
                        <option value="3">Апрель</option><option value="4">Май</option><option value="5">Июнь</option>
                        <option value="6">Июль</option><option value="7">Август</option><option value="8">Сентябрь</option>
                        <option value="9">Октябрь</option><option value="10">Ноябрь</option><option value="11">Декабрь</option>
                    </select>
                    <select id="selected-year-employee-payments" aria-label="Год"></select>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Месяц</th>
                            <th>Обычные смены</th>
                            <th>Дополнительные смены</th>
                            <th>Итого часов</th>
                            <th>Итого к выплате</th>
                            <th>Статус</th>
                        </tr>
                    </thead>
                    <tbody id="employee-payments-tbody"></tbody>
                </table>
            </div>

            <div id="employee-profile" class="tab-content">
                <h2>Мой профиль</h2>
                <div class="success-message" id="profile-success" style="display: none;"></div>
                <div class="error-message" id="profile-error" style="display: none;"></div>
                <form id="update-profile-form">
                    <input type="text" id="profile-name" placeholder="Имя" required aria-label="Имя">
                    <input type="number" id="profile-rate" placeholder="Ставка за час" step="0.01" min="0" required aria-label="Ставка за час">
                    <select id="profile-post" required aria-label="Пост">
                        <option value="">Выберите пост</option>
                    </select>
                    <button type="submit">Обновить профиль <span class="loading" style="display: none;"></span></button>
                </form>
            </div>
        </section>
    </main>
    <footer>
        <p>&copy; 2025 Личный кабинет Охранника. Все права защищены.</p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Инициализация Supabase
        const supabaseUrl = 'SUPABASE_URL'; // Замените на ваш URL
        const supabaseAnonKey = 'SUPABASE_ANON_KEY'; // Замените на ваш анонимный ключ
        const supabase = supabase.createClient(supabaseUrl, supabaseAnonKey);

        // Глобальные переменные
        let currentUser = null;
        let isAdmin = false;
        let shiftsData = {};
        let postsData = [];
        let employeesData = [];
        let paymentsData = {};

        // DOM элементы
        const sections = {
            welcome: document.getElementById('welcome'),
            login: document.getElementById('login'),
            admin: document.getElementById('admin'),
            employee: document.getElementById('employee')
        };
        const logoutBtn = document.getElementById('logout-btn');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const loginLoading = document.getElementById('login-loading');
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');

        // Инициализация приложения
        async function initApp() {
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                currentUser = session.user;
                await checkUserRole();
                showSection(isAdmin ? 'admin' : 'employee');
                logoutBtn.style.display = 'block';
                await loadData();
            } else {
                showSection('welcome');
                showSection('login');
            }
        }

        // Проверка роли пользователя
        async function checkUserRole() {
            const { data, error } = await supabase
                .from('users')
                .select('role')
                .eq('id', currentUser.id)
                .single();
            if (error) {
                console.error('Error checking role:', error);
                isAdmin = false;
            } else {
                isAdmin = data.role === 'admin';
            }
        }

        // Показать секцию
        function showSection(sectionId) {
            Object.values(sections).forEach(section => section.style.display = 'none');
            sections[sectionId].style.display = 'block';
        }

        // Загрузка данных
        async function loadData() {
            if (isAdmin) {
                await Promise.all([
                    loadPosts(),
                    loadEmployees(),
                    loadShifts(),
                    loadPayments()
                ]);
            } else {
                await Promise.all([
                    loadEmployeeShifts(),
                    loadEmployeePayments()
                ]);
            }
        }

        // Загрузка постов
        async function loadPosts() {
            const { data, error } = await supabase.from('posts').select('*');
            if (error) {
                console.error('Error loading posts:', error);
                showError('posts-error', 'Ошибка загрузки постов');
            } else {
                postsData = data;
                updatePostsList();
                updatePostSelects();
            }
        }

        // Загрузка сотрудников
        async function loadEmployees() {
            const { data, error } = await supabase.from('users').select('*').neq('role', 'admin');
            if (error) {
                console.error('Error loading employees:', error);
                showError('employees-error', 'Ошибка загрузки сотрудников');
            } else {
                employeesData = data;
                updateEmployeesTable();
                updateEmployeeSelects();
            }
        }

        // Загрузка смен
        async function loadShifts() {
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const startDate = new Date(currentYear, currentMonth, 1);
            const endDate = new Date(currentYear, currentMonth + 1, 0);

            const { data, error } = await supabase
                .from('shifts')
                .select('*')
                .gte('date', startDate.toISOString().split('T')[0])
                .lte('date', endDate.toISOString().split('T')[0]);

            if (error) {
                console.error('Error loading shifts:', error);
                showError('shifts-error', 'Ошибка загрузки смен');
            } else {
                shiftsData = {};
                data.forEach(shift => {
                    const key = `${shift.user_id}-${shift.date}`;
                    shiftsData[key] = shift;
                });
                updateShiftsTable();
            }
        }

        // Загрузка выплат
        async function loadPayments() {
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const monthStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;

            const { data, error } = await supabase
                .from('payments')
                .select('*')
                .eq('month', monthStr);

            if (error) {
                console.error('Error loading payments:', error);
                showError('payments-error', 'Ошибка загрузки выплат');
            } else {
                paymentsData = {};
                data.forEach(payment => {
                    paymentsData[payment.user_id] = payment;
                });
                updatePaymentsTable();
            }
        }

        // Загрузка смен сотрудника
        async function loadEmployeeShifts() {
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const startDate = new Date(currentYear, currentMonth, 1);
            const endDate = new Date(currentYear, currentMonth + 1, 0);

            const { data, error } = await supabase
                .from('shifts')
                .select('*')
                .eq('user_id', currentUser.id)
                .gte('date', startDate.toISOString().split('T')[0])
                .lte('date', endDate.toISOString().split('T')[0]);

            if (error) {
                console.error('Error loading employee shifts:', error);
                showError('employee-shifts-error', 'Ошибка загрузки смен');
            } else {
                updateEmployeeCalendar(data);
            }
        }

        // Загрузка выплат сотрудника
        async function loadEmployeePayments() {
            const { data, error } = await supabase
                .from('payments')
                .select('*')
                .eq('user_id', currentUser.id);

            if (error) {
                console.error('Error loading employee payments:', error);
                showError('employee-payments-error', 'Ошибка загрузки выплат');
            } else {
                updateEmployeePaymentsTable(data);
            }
        }

        // Обновление списка постов
        function updatePostsList() {
            const postsList = document.getElementById('posts-list');
            postsList.innerHTML = '';
            postsData.forEach(post => {
                const postItem = document.createElement('div');
                postItem.className = 'post-item';
                postItem.innerHTML = `
                    <h3>${post.name}</h3>
                    <p>${post.description || 'Нет описания'}</p>
                    <button class="btn-danger" onclick="deletePost(${post.id})">Удалить</button>
                `;
                postsList.appendChild(postItem);
            });
        }

        // Обновление селектов постов
        function updatePostSelects() {
            const selects = document.querySelectorAll('#employee-post, #profile-post');
            selects.forEach(select => {
                select.innerHTML = '<option value="">Выберите пост</option>';
                postsData.forEach(post => {
                    const option = document.createElement('option');
                    option.value = post.id;
                    option.textContent = post.name;
                    select.appendChild(option);
                });
            });
        }

        // Обнов
// Обновление селектов постов
function updatePostSelects() {
    const selects = document.querySelectorAll('#employee-post, #profile-post');
    selects.forEach(select => {
        select.innerHTML = '<option value="">Выберите пост</option>';
        postsData.forEach(post => {
            const option = document.createElement('option');
            option.value = post.id;
            option.textContent = post.name;
            select.appendChild(option);
        });
    });
}

// Обновление таблицы сотрудников
function updateEmployeesTable() {
    const tbody = document.getElementById('employees-tbody');
    tbody.innerHTML = '';
    employeesData.forEach(employee => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${employee.name}</td>
            <td>${employee.email}</td>
            <td>${employee.rate} руб/час</td>
            <td>${postsData.find(p => p.id == employee.post_id)?.name || 'Не назначен'}</td>
            <td>
                <button class="btn-danger" onclick="deleteEmployee('${employee.id}')">Удалить</button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// Обновление селектов сотрудников
function updateEmployeeSelects() {
    const selects = document.querySelectorAll('#shift-employee');
    selects.forEach(select => {
        select.innerHTML = '<option value="">Выберите сотрудника</option>';
        employeesData.forEach(employee => {
            const option = document.createElement('option');
            option.value = employee.id;
            option.textContent = employee.name;
            select.appendChild(option);
        });
    });
}

// Обновление таблицы смен
function updateShiftsTable() {
    const tbody = document.getElementById('shifts-admin-tbody');
    tbody.innerHTML = '';
    const currentMonth = new Date().getMonth();
    const currentYear = new Date().getFullYear();
    const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

    employeesData.forEach(employee => {
        const row = document.createElement('tr');
        row.innerHTML = `<td>${employee.name}</td>`;
        for (let day = 1; day <= daysInMonth; day++) {
            const date = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const key = `${employee.id}-${date}`;
            const shift = shiftsData[key];
            let cellClass = '';
            let cellContent = '';
            if (shift) {
                if (shift.status === 'done') cellClass = 'shift-done';
                else if (shift.status === 'paid') cellClass = 'shift-paid';
                else if (shift.type === 'extra') cellClass = 'shift-extra';
                else cellClass = 'shift-regular';
                cellContent = shift.hours || '';
            }
            row.innerHTML += `<td class="${cellClass}" onclick="editShift('${employee.id}', '${date}')">${cellContent}</td>`;
        }
        tbody.appendChild(row);
    });
}

// Обновление таблицы выплат
function updatePaymentsTable() {
    const tbody = document.getElementById('payments-tbody');
    tbody.innerHTML = '';
    employeesData.forEach(employee => {
        const payment = paymentsData[employee.id];
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${employee.name}</td>
            <td>${payment?.regular_shifts || 0}</td>
            <td>${payment?.extra_shifts || 0}</td>
            <td>${payment?.total_hours || 0}</td>
            <td>${employee.rate} руб/час</td>
            <td>${payment?.total_amount || 0} руб</td>
            <td>${payment?.status || 'Не рассчитано'}</td>
            <td>
                <button onclick="markAsPaid('${employee.id}')">Отметить оплаченным</button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// Обновление календаря сотрудника
function updateEmployeeCalendar(shifts) {
    const calendar = document.getElementById('employee-calendar');
    calendar.innerHTML = '';
    const currentMonth = new Date().getMonth();
    const currentYear = new Date().getFullYear();
    const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

    for (let day = 1; day <= daysInMonth; day++) {
        const date = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const shift = shifts.find(s => s.date === date);
        let cellClass = 'shift-dayoff';
        let cellContent = day;
        if (shift) {
            if (shift.status === 'done') cellClass = 'shift-done';
            else if (shift.status === 'paid') cellClass = 'shift-paid';
            else if (shift.type === 'extra') cellClass = 'shift-extra';
            else cellClass = 'shift-regular';
            cellContent += `<br>${shift.hours}ч`;
        }
        const cell = document.createElement('div');
        cell.className = `calendar-cell ${cellClass}`;
        cell.innerHTML = cellContent;
        calendar.appendChild(cell);
    }
}

// Обновление таблицы выплат сотрудника
function updateEmployeePaymentsTable(payments) {
    const tbody = document.getElementById('employee-payments-tbody');
    tbody.innerHTML = '';
    payments.forEach(payment => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${payment.month}</td>
            <td>${payment.regular_shifts}</td>
            <td>${payment.extra_shifts}</td>
            <td>${payment.total_hours}</td>
            <td>${payment.total_amount} руб</td>
            <td>${payment.status}</td>
        `;
        tbody.appendChild(row);
    });
}

// Обработчики событий
document.addEventListener('DOMContentLoaded', () => {
    initApp();

    // Табы
    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            const tabId = tab.dataset.tab;
            tabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            tabContents.forEach(content => {
                content.classList.remove('active');
                if (content.id === tabId) content.classList.add('active');
            });
        });
    });

    // Форма входа
    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        loginError.style.display = 'none';
        loginLoading.style.display = 'inline';
        const { error } = await supabase.auth.signInWithPassword({ email, password });
        loginLoading.style.display = 'none';
        if (error) {
            showError('login-error', error.message);
        } else {
            await initApp();
        }
    });

    // Выход
    logoutBtn.addEventListener('click', async () => {
        await supabase.auth.signOut();
        currentUser = null;
        isAdmin = false;
        showSection('welcome');
        showSection('login');
        logoutBtn.style.display = 'none';
    });

    // Форма добавления смены
    document.getElementById('add-shift-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData);
        data.user_id = data.employee;
        data.date = data.date;
        data.type = data.type;
        data.hours = parseFloat(data.hours);
        delete data.employee;
        const { error } = await supabase.from('shifts').upsert(data);
        if (error) {
            showError('shifts-error', error.message);
        } else {
            showSuccess('shifts-success', 'Смена добавлена');
            loadShifts();
        }
    });

    // Форма добавления поста
    document.getElementById('add-post-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const { error } = await supabase.from('posts').insert(Object.fromEntries(formData));
        if (error) {
            showError('posts-error', error.message);
        } else {
            showSuccess('posts-success', 'Пост добавлен');
            loadPosts();
        }
    });

    // Форма добавления сотрудника
    document.getElementById('add-employee-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData);
        data.role = 'employee';
        const { error } = await supabase.from('users').insert(data);
        if (error) {
            showError('employees-error', error.message);
        } else {
            showSuccess('employees-success', 'Сотрудник добавлен');
            loadEmployees();
        }
    });

    // Форма обновления профиля
    document.getElementById('update-profile-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData);
        const { error } = await supabase.from('users').update(data).eq('id', currentUser.id);
        if (error) {
            showError('profile-error', error.message);
        } else {
            showSuccess('profile-success', 'Профиль обновлен');
            await loadData();
        }
    });

    // Кнопка расчета выплат
    document.getElementById('calculate-payments-btn').addEventListener('click', calculatePayments);

    // Экспорт CSV
    document.getElementById('export-payments-btn').addEventListener('click', exportPaymentsCSV);
    document.getElementById('export-employee-shifts-btn').addEventListener('click', exportEmployeeShiftsCSV);

    // Инициализация селектов годов
    const yearSelects = document.querySelectorAll('[id*="selected-year"]');
    const currentYear = new Date().getFullYear();
    yearSelects.forEach(select => {
        for (let year = currentYear - 1; year <= currentYear + 1; year++) {
            const option = document.createElement('option');
            option.value = year;
            option.textContent = year;
            if (year === currentYear) option.selected = true;
            select.appendChild(option);
        }
    });
});

// Функции действий
async function editShift(userId, date) {
    const shift = shiftsData[`${userId}-${date}`];
    if (shift) {
        // Логика редактирования смены (можно добавить модальное окно)
        alert('Редактирование смены: ' + JSON.stringify(shift));
    } else {
        // Добавить новую смену
        const hours = prompt('Введите часы для новой смены:');
        if (hours) {
            const { error } = await supabase.from('shifts').insert({
                user_id: userId,
                date: date,
                hours: parseFloat(hours),
                type: 'regular'
            });
            if (error) {
                showError('shifts-error', error.message);
            } else {
                loadShifts();
            }
        }
    }
}

async function deletePost(id) {
    if (confirm('Удалить пост?')) {
        const { error } = await supabase.from('posts').delete().eq('id', id);
        if (error) {
            showError('posts-error', error.message);
        } else {
            loadPosts();
        }
    }
}

async function deleteEmployee(id) {
    if (confirm('Удалить сотрудника?')) {
        const { error } = await supabase.from('users').delete().eq('id', id);
        if (error) {
            showError('employees-error', error.message);
        } else {
            loadEmployees();
        }
    }
}

async function markAsPaid(userId) {
    const { error } = await supabase.from('payments').update({ status: 'paid' }).eq('user_id', userId);
    if (error) {
        showError('payments-error', error.message);
    } else {
        loadPayments();
    }
}

async function calculatePayments() {
    const month = document.getElementById('selected-month-payments').value;
    const year = document.getElementById('selected-year-payments').value;
    const monthStr = `${year}-${String(parseInt(month) + 1).padStart(2, '0')}`;
    // Логика расчета выплат (суммирование часов и т.д.)
    // Для примера: простая логика
    for (const employee of employeesData) {
        const shifts = await supabase.from('shifts').select('*').eq('user_id', employee.id).like('date', `${monthStr}%`);
        let regular = 0, extra = 0, totalHours = 0;
        shifts.data.forEach(shift => {
            if (shift.type === 'extra') extra++;
            else regular++;
            totalHours += shift.hours;
        });
        const totalAmount = totalHours * employee.rate;
        await supabase.from('payments').upsert({
            user_id: employee.id,
            month: monthStr,
            regular_shifts: regular,
            extra_shifts: extra,
            total_hours: totalHours,
            total_amount: totalAmount,
            status: 'calculated'
        });
    }
    loadPayments();
}

// Экспорт функций
function exportPaymentsCSV() {
    let csv = 'Сотрудник,Обычные смены,Дополнительные смены,Итого часов,Ставка,Итого к выплате,Статус\n';
    employeesData.forEach(employee => {
        const payment = paymentsData[employee.id];
        csv += `${employee.name},${payment?.regular_shifts || 0},${payment?.extra_shifts || 0},${payment?.total_hours || 0},${employee.rate},${payment?.total_amount || 0},${payment?.status || 'Не рассчитано'}\n`;
    });
    downloadCSV(csv, 'payments.csv');
}

function exportEmployeeShiftsCSV() {
    // Аналогично для смен сотрудника
    alert('Экспорт смен сотрудника (реализовать по аналогии)');
}

function downloadCSV(csv, filename) {
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
}

// Утилиты
function showError(id, message) {
    const el = document.getElementById(id);
    el.textContent = message;
    el.style.display = 'block';
    setTimeout(() => el.style.display = 'none', 5000);
}

function showSuccess(id, message) {
    const el = document.getElementById(id);
    el.textContent = message;
    el.style.display = 'block';
    setTimeout(() => el.style.display = 'none', 3000);
}
    </script>
</body>
</html>
